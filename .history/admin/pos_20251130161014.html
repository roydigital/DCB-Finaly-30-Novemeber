<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCB POS | Walk-in Terminal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/mousetrap@1.6.5/mousetrap.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            red: '#D92323',
                            dark: '#1a1a1a',
                            cream: '#f4f1ea',
                            gray: '#f3f4f6',
                            green: '#16a34a'
                        }
                    },
                    fontFamily: {
                        display: ['Oswald', 'sans-serif'],
                        body: ['Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .pos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .ticket-pattern {
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 10px 10px;
        }
    </style>
</head>
<body class="bg-brand-dark h-screen overflow-hidden font-body flex flex-col md:flex-row text-gray-800">

    <div class="flex-1 flex flex-col bg-gray-100 h-full relative">
        
        <div class="bg-white shadow-sm z-20">
            <div class="p-4 border-b border-gray-200 flex gap-4 items-center">
                <a href="admin.html" class="w-10 h-10 bg-brand-dark text-white rounded flex items-center justify-center hover:bg-gray-800 transition">
                    <i class="fa-solid fa-house"></i>
                </a>
                
                <div class="relative flex-1">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="pos-search" placeholder="Search Menu (Alt+S)..." class="w-full pl-10 pr-4 py-3 bg-gray-100 border-none rounded-lg focus:ring-2 focus:ring-brand-red text-lg font-bold">
                </div>
            </div>

            <div class="flex overflow-x-auto p-2 gap-2 no-scrollbar border-b border-gray-200" id="category-bar">
                </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 bg-brand-gray relative" id="menu-container">
            <div class="pos-grid" id="menu-grid">
                </div>
        </div>

        <div class="bg-brand-dark text-gray-400 px-4 py-2 text-xs flex justify-between items-center">
            <span><i class="fa-solid fa-circle text-green-500 mr-2"></i>System Online</span>
            <span>Terminal: POS-01 (Walk-in Mode)</span>
        </div>
    </div>

    <div class="w-full md:w-[450px] bg-white shadow-2xl z-30 flex flex-col h-full border-l border-gray-300">
        
        <div class="p-4 bg-brand-cream border-b border-orange-100">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-display font-bold text-lg text-brand-dark">CUSTOMER DETAILS</h3>
                <span class="bg-white px-2 py-1 rounded text-xs font-bold border border-gray-200" id="customer-status">NEW</span>
            </div>
            
            <div class="relative mb-2">
                <i class="fa-solid fa-phone absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                <input type="tel" id="cust-phone" onkeyup="checkCustomer()" placeholder="Mobile Number (Required)" class="w-full pl-8 pr-3 py-2 border rounded focus:border-brand-red focus:outline-none text-sm font-bold tracking-wide">
                <div id="cust-found-badge" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-green-600 hidden">
                    <i class="fa-solid fa-circle-check"></i> Found
                </div>
            </div>
            <input type="text" id="cust-name" placeholder="Customer Name" class="w-full px-3 py-2 border rounded focus:border-brand-red focus:outline-none text-sm bg-white">
        </div>

        <div class="grid grid-cols-2 bg-gray-100 p-1 gap-1 border-b border-gray-200">
            <button onclick="setOrderType('walkin')" id="btn-walkin" class="py-2 text-sm font-bold rounded bg-brand-dark text-white shadow">Walk-In</button>
            <button onclick="setOrderType('dining')" id="btn-dining" class="py-2 text-sm font-bold rounded text-gray-600 hover:bg-white">Dining</button>
        </div>

        <div class="flex-1 overflow-y-auto p-2 ticket-pattern space-y-1" id="cart-list">
            <div class="h-full flex flex-col items-center justify-center text-gray-300 opacity-50">
                <i class="fa-solid fa-cash-register text-5xl mb-2"></i>
                <p>Ready for Order</p>
            </div>
        </div>

        <div class="bg-white border-t border-gray-200 p-4 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
            <div class="space-y-1 text-sm mb-4 text-gray-600">
                <div class="flex justify-between font-bold text-gray-800 text-lg border-t border-dashed border-gray-300 pt-2 mt-2">
                    <span>TOTAL TO PAY</span>
                    <span id="lbl-total">₹0</span>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-2 mb-4">
                <button onclick="setPayMode('cash')" id="pm-cash" class="pay-btn active bg-gray-800 text-white border border-gray-800 py-2 rounded font-bold text-xs flex flex-col items-center gap-1">
                    <i class="fa-solid fa-money-bill-wave"></i> CASH
                </button>
                <button onclick="setPayMode('upi')" id="pm-upi" class="pay-btn bg-white text-gray-600 border border-gray-200 py-2 rounded font-bold text-xs flex flex-col items-center gap-1 hover:border-brand-red">
                    <i class="fa-solid fa-qrcode"></i> UPI
                </button>
                <button onclick="setPayMode('card')" id="pm-card" class="pay-btn bg-white text-gray-600 border border-gray-200 py-2 rounded font-bold text-xs flex flex-col items-center gap-1 hover:border-brand-red">
                    <i class="fa-solid fa-credit-card"></i> CARD
                </button>
            </div>

            <button onclick="handlePosCheckout()" id="btn-checkout" class="w-full bg-brand-green hover:bg-green-700 text-white py-4 rounded-lg font-bold text-xl shadow-lg flex items-center justify-center gap-3 transition transform active:scale-95">
                <span>PLACE ORDER</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Variant Selection Modal -->
    <div id="variantModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-center" id="variantModalTitle">Select Portion</h3>
            <div id="variantOptions" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
                <!-- Variant options will be injected here -->
            </div>
            <div class="flex gap-3 justify-center">
                <button onclick="closeVariantModal()" class="px-4 py-2 border rounded text-gray-600 hover:bg-gray-100">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // 1. CONFIGURATION
        const SUPABASE_URL = 'https://kjbelegkbusvtvtcgwhq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtqYmVsZWdrYnVzdnR2dGNnd2hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MjI5ODIsImV4cCI6MjA3NDA5ODk4Mn0.-K-rkuJnyDPL5YnkJ62-UG1_mG0BIILMUEZpSTNnq5M';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // State Variables
        let cart = [];
        let menuItems = []; 
        let currentOrderType = 'walkin';
        let currentPayMode = 'cash';

        // 2. INITIALIZATION
        document.addEventListener('DOMContentLoaded', () => {
            fetchMenu(); // Fetch items from Supabase or hardcode for now
            document.getElementById('pos-search').focus();
        });

        // 3. FETCH MENU (Using your existing menu logic)
        async function fetchMenu() {
            // NOTE: Ensure you have a 'menu_items' table. If not, use this dummy data to test UI.
            const { data, error } = await supabase.from('menu_items').select('*').eq('in_stock', true);
            
            if (error || !data || data.length === 0) {
                console.log("Using fallback data for menu");
                // FALLBACK DATA IF TABLE IS EMPTY
                menuItems = [
                    { id: 1, name: 'Cheese Burger', category: 'Burgers', prices: { 'Regular': 120 } },
                    { id: 2, name: 'Chicken Wings', category: 'Sides', prices: { '6pcs': 150, '12pcs': 280 } },
                    { id: 3, name: 'Coke', category: 'Drinks', prices: { '300ml': 40 } }
                ];
            } else {
                menuItems = data;
            }
            renderMenu();
        }

        // 4. RENDER MENU GRID
        function renderMenu(filterCat = 'All') {
            const grid = document.getElementById('menu-grid');
            const search = document.getElementById('pos-search').value.toLowerCase();
            
            // Unique Categories
            const categories = ['All', ...new Set(menuItems.map(i => i.category))];
            
            // Render Category Bar
            document.getElementById('category-bar').innerHTML = categories.map(cat => `
                <button onclick="renderMenu('${cat}')" class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-bold hover:bg-brand-red hover:text-white transition">${cat}</button>
            `).join('');

            // Filter Logic
            const filtered = menuItems.filter(item => {
                const matchesCat = filterCat === 'All' || item.category === filterCat;
                const matchesSearch = item.name.toLowerCase().includes(search);
                return matchesCat && matchesSearch;
            });

            // Render Cards
            grid.innerHTML = filtered.map(item => {
                const variants = Object.entries(item.prices || {});
                
                return `
                <div onclick="showVariantModal('${item.id}', '${item.name}', '${item.category}')" 
                     class="bg-white rounded-lg shadow p-3 cursor-pointer hover:border-brand-red border border-transparent transition h-32 flex flex-col justify-between">
                    <div>
                        <div class="text-xs text-gray-400 font-bold uppercase mb-1">${item.category}</div>
                        <h4 class="font-bold text-gray-800 leading-tight">${item.name}</h4>
                    </div>
                    <div class="flex justify-between items-end mt-2">
                        <div class="text-xs text-gray-600">
                            ${variants.length > 1 ? `${variants.length} variants` : '₹' + variants[0][1]}
                        </div>
                        <div class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-gray-400">
                            <i class="fa-solid fa-plus text-xs"></i>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Search Listener
        document.getElementById('pos-search').addEventListener('keyup', () => renderMenu());

        // 5. CART FUNCTIONS
        function addToCart(id, name, variant, price) {
            const existing = cart.find(i => i.id == id && i.variant == variant);
            if(existing) {
                existing.qty++;
            } else {
                cart.push({ id, name, variant, price, qty: 1 });
            }
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cart-list');
            if(cart.length === 0) {
                container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-gray-300 opacity-50"><p>Empty Cart</p></div>`;
                document.getElementById('lbl-total').innerText = '₹0';
                return;
            }

            container.innerHTML = cart.map((item, idx) => `
                <div class="bg-white p-3 border-b border-dashed border-gray-300 flex justify-between items-start">
                    <div>
                        <div class="font-bold text-gray-800 text-sm">${item.name}</div>
                        <div class="text-xs text-gray-500">${item.variant} x ${item.qty}</div>
                    </div>
                    <div class="font-bold text-gray-800">₹${item.price * item.qty}</div>
                </div>
            `).join('');

            const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            document.getElementById('lbl-total').innerText = '₹' + total;
        }

        // 6. CUSTOMER LOOKUP (The Key Feature)
        async function checkCustomer() {
            const phone = document.getElementById('cust-phone').value;
            if (phone.length === 10) {
                const { data, error } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('phone', phone)
                    .single();
                
                if (data) {
                    document.getElementById('cust-name').value = data.name;
                    document.getElementById('customer-status').innerText = "FOUND";
                    document.getElementById('customer-status').classList.replace('text-gray-500', 'text-green-600');
                    document.getElementById('cust-found-badge').classList.remove('hidden');
                } else {
                    document.getElementById('customer-status').innerText = "NEW";
                    document.getElementById('cust-found-badge').classList.add('hidden');
                }
            }
        }

        // 7. HANDLE CHECKOUT (New simplified Logic)
        async function handlePosCheckout() {
            const phone = document.getElementById('cust-phone').value;
            const name = document.getElementById('cust-name').value;
            const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);

            if (cart.length === 0) return alert("Cart is empty!");
            if (!phone || phone.length < 10) return alert("Please enter a valid 10-digit phone number.");
            if (!name) return alert("Please enter customer name.");

            const btn = document.getElementById('btn-checkout');
            btn.innerHTML = 'Processing...';
            btn.disabled = true;

            try {
                // Step A: Find or Create Customer
                let customerId;
                
                // Try to find
                let { data: existingUser } = await supabase.from('customers').select('id').eq('phone', phone).single();
                
                if (existingUser) {
                    customerId = existingUser.id;
                } else {
                    // Create New
                    const { data: newUser, error: createError } = await supabase
                        .from('customers')
                        .insert([{ name: name, phone: phone }])
                        .select()
                        .single();
                    
                    if (createError) throw createError;
                    customerId = newUser.id;
                }

                // Step B: Create Order
                const { error: orderError } = await supabase
                    .from('orders')
                    .insert([{
                        customer_id: customerId,
                        items: cart, // Storing JSON directly
                        total_amount: total,
                        order_type: currentOrderType,
                        payment_method: currentPayMode,
                        status: 'completed'
                    }]);

                if (orderError) throw orderError;

                alert("Order Placed Successfully!");
                location.reload(); // Reset terminal

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                btn.innerHTML = 'PLACE ORDER';
                btn.disabled = false;
            }
        }

        // Helper setters
        function setOrderType(type) { 
            currentOrderType = type;
            document.querySelectorAll('#btn-walkin, #btn-dining').forEach(b => b.classList.remove('bg-brand-dark', 'text-white'));
            document.getElementById(`btn-${type}`).classList.add('bg-brand-dark', 'text-white');
        }
        function setPayMode(mode) {
            currentPayMode = mode;
            document.querySelectorAll('.pay-btn').forEach(b => b.classList.remove('bg-gray-800', 'text-white'));
            document.getElementById(`pm-${mode}`).classList.add('bg-gray-800', 'text-white');
        }

        // Variant Selection Functions
        let currentItemId = null;
        let currentItemName = null;

        function showVariantModal(id, name, category) {
            const item = menuItems.find(i => i.id == id);
            if (!item) return;

            currentItemId = id;
            currentItemName = name;

            document.getElementById('variantModalTitle').innerText = `${name} - Select Portion`;
            const variantOptions = document.getElementById('variantOptions');
            
            const variants = Object.entries(item.prices || {});
            
            if (variants.length === 1) {
                // If only one variant, add directly to cart
                addToCart(id, name, variants[0][0], variants[0][1]);
                return;
            }

            variantOptions.innerHTML = variants.map(([variant, price]) => `
                <button onclick="selectVariant('${variant}', ${price})" 
