<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCB - Delhi Chicken Brothers | Online Ordering</title>
    
    <!-- Favicon -->
    <link rel="icon" href="asset/logo.png" type="image/png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            red: '#BA412D', // Updated to brand red #BA412D
                            dark: '#1a1a1a',
                            cream: '#f4f1ea',
                            gold: '#f59e0b'
                        }
                    },
                    fontFamily: {
                        display: ['Oswald', 'sans-serif'],
                        body: ['Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #BA412D; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9A3120; 
        }
        .animate-bounce-short {
            animation: bounce-short 0.3s ease-in-out 2 alternate;
        }
        @keyframes bounce-short {
            0% { transform: translateY(0); }
            100% { transform: translateY(-5px); }
        }
        
        /* Cart Item Animations */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .cart-item-enter {
            animation: slideInRight 0.3s ease-out;
        }
        
        /* Pulse Animation for Highlights */
        @keyframes pulse-gold {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
            }
            50% {
                box-shadow: 0 0 0 6px rgba(245, 158, 11, 0);
            }
        }
        
        .animate-pulse-gold {
            animation: pulse-gold 2s infinite;
        }
        
        /* Gradient Border Animation */
        @keyframes gradient-border {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        
        .gradient-border {
            background: linear-gradient(90deg, #BA412D, #f59e0b, #BA412D);
            background-size: 200% 200%;
            animation: gradient-border 3s ease infinite;
        }
        
        /* Shake Animation for Empty Cart */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }
        
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        /* Floating Animation */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
    </style>

    <!-- Meta Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '848998828089233');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=848998828089233&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
</head>
<body class="bg-brand-cream text-gray-800 font-body antialiased">

    <!-- Initialize Data Modal (Hidden by default) -->
    <div id="seedModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full shadow-2xl text-center">
            <i class="fa-solid fa-database text-4xl text-brand-red mb-4"></i>
            <h2 class="text-2xl font-bold font-display mb-2">Setup Database?</h2>
            <p class="text-gray-600 mb-6">Your menu appears to be empty. Would you like to upload the standard menu items (Kebabs, Curries, Rolls) to your database now?</p>
            <div class="flex gap-4 justify-center">
                <button onclick="closeSeedModal()" class="px-4 py-2 border border-gray-300 rounded text-gray-600 hover:bg-gray-50">No, Empty is fine</button>
                <button onclick="seedDatabase()" class="px-4 py-2 bg-brand-red text-white rounded hover:bg-[#9A3120] font-bold shadow-lg">Yes, Upload Menu</button>
            </div>
            <p id="seedStatus" class="mt-4 text-sm font-semibold"></p>
        </div>
    </div>

    <!-- Location Permission Modal -->
    <div id="locationModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full shadow-2xl text-center">
            <i class="fa-solid fa-location-dot text-4xl text-brand-red mb-4"></i>
            <h2 class="text-2xl font-bold font-display mb-2">Share Your Location</h2>
            <p class="text-gray-600 mb-6">To provide you with better service and accurate delivery estimates, we need to access your location. This will only be used to improve your ordering experience.</p>
            <div class="flex gap-4 justify-center">
                <button onclick="denyLocation()" class="px-4 py-2 border border-gray-300 rounded text-gray-600 hover:bg-gray-50">Not Now</button>
                <button onclick="requestLocation()" class="px-4 py-2 bg-brand-red text-white rounded hover:bg-[#9A3120] font-bold shadow-lg">Allow Location</button>
            </div>
            <p id="locationStatus" class="mt-4 text-sm font-semibold"></p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="sticky top-0 z-40 bg-white shadow-md border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo Area -->
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 flex items-center justify-center">
                        <img src="asset/logo.png" alt="DCB Logo" class="h-full w-auto object-contain">
                    </div>
                    <div class="hidden md:block">
                        <h1 class="text-xl font-bold font-display tracking-wide text-brand-dark leading-none">DELHI CHICKEN BROTHERS (DCB)</h1>
                        <span class="text-xs text-brand-red font-medium tracking-widest uppercase">Authentic Taste Legacy</span>
                    </div>
                </div>

                <!-- Desktop Nav -->
                <div class="hidden md:flex items-center space-x-8">
                    <button onclick="scrollToMenu()" class="text-brand-dark hover:text-brand-red font-medium transition">Menu</button>
                </div>

                <!-- Cart Icon -->
                <div class="relative cursor-pointer" onclick="toggleCart()">
                    <div class="p-2 hover:bg-gray-100 rounded-full transition">
                        <img src="asset/bucket icon.svg" alt="Cart" class="h-6 w-6">
                    </div>
                    <span id="cart-badge" class="absolute top-0 right-0 bg-brand-red text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full transform scale-0 transition-transform duration-200">0</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="relative bg-brand-dark text-white overflow-hidden">
        <div class="absolute inset-0 bg-[url('asset/Hero%20Image.jpg')] bg-cover bg-center"></div>
        <div class="absolute inset-0 bg-black opacity-40"></div>
        <div class="relative max-w-7xl mx-auto py-24 px-4 sm:px-6 lg:px-8 text-center sm:text-left">
            <h1 class="text-4xl md:text-6xl font-display font-bold mb-4 tracking-tight">
                THE REAL <span class="text-brand-red">TASTE OF DELHI</span>
            </h1>
            <p class="text-xl text-gray-300 mb-8 max-w-2xl">
                Experience the authentic flavors of roasted kebabs, creamy curries, and crunchy rolls. Directly from the grill to your doorstep.
            </p>
            <button onclick="scrollToMenu()" class="bg-brand-red hover:bg-[#9A3120] text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:-translate-y-1">
                ORDER NOW
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 flex flex-col md:flex-row gap-8 relative">
        
        <!-- Menu Section -->
        <div class="flex-1">
            <!-- Categories Filters -->
            <div class="sticky top-16 z-30 bg-brand-cream py-4 -mx-4 px-4 md:mx-0 md:px-0 overflow-x-auto">
                <div class="flex space-x-2 md:flex-wrap" id="category-filters">
                    <!-- Filters injected by JS -->
                    <div class="animate-pulse flex space-x-2">
                        <div class="h-10 w-24 bg-gray-300 rounded-full"></div>
                        <div class="h-10 w-24 bg-gray-300 rounded-full"></div>
                        <div class="h-10 w-24 bg-gray-300 rounded-full"></div>
                    </div>
                </div>
            </div>

            <!-- Menu Grid -->
            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 mt-6">
                <!-- Items injected by JS -->
                <div class="text-center col-span-full py-10 text-gray-500">
                    <i class="fa-solid fa-spinner fa-spin text-3xl mb-3"></i>
                    <p>Loading delicious menu...</p>
                </div>
            </div>
        </div>

        <!-- Cart Sidebar (Desktop Sticky / Mobile Drawer) -->
<aside id="cart-sidebar" class="fixed inset-y-0 right-0 w-full sm:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 md:relative md:transform-none md:w-80 md:block md:translate-x-0 md:shadow-none md:bg-transparent">
            <div class="h-full md:h-auto md:sticky md:top-24 bg-gradient-to-b from-white to-brand-cream/30 md:rounded-xl md:shadow-2xl overflow-hidden flex flex-col border border-gray-100">
                
                <!-- Cart Header -->
                <div class="bg-gradient-to-r from-brand-dark to-brand-red p-4 flex justify-between items-center text-white relative overflow-hidden shrink-0">
<div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1555939594-58d7cb561ad1?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80')] bg-cover bg-center opacity-10 pointer-events-none"></div>
                    <div class="relative z-10 flex items-center gap-3">
                        <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-basket-shopping text-lg"></i>
                        </div>
                        <div>
                            <h2 class="font-display text-xl font-bold">Your Order</h2>
                            <p class="text-xs text-white/80 font-medium">Delicious food awaits!</p>
                        </div>
                    </div>
                    <button class="md:hidden text-white/80 hover:text-white bg-white/10 hover:bg-white/20 p-2 rounded-full transition" onclick="toggleCart()" title="Close cart" aria-label="Close cart">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>

                <!-- Scrollable Content Area -->
                <div class="flex-1 overflow-y-auto flex flex-col">
                    <!-- Cart Items Area -->
                    <div id="cart-items" class="p-4 space-y-4">
                        <div class="flex flex-col items-center justify-center h-48 text-gray-500">
                            <div class="relative mb-4">
                                <div class="w-20 h-20 bg-gradient-to-br from-brand-cream to-white rounded-full flex items-center justify-center shadow-inner">
                                    <i class="fa-solid fa-burger text-3xl text-brand-red/50"></i>
                                </div>
                                <div class="absolute -top-2 -right-2 w-10 h-10 bg-brand-gold/20 rounded-full flex items-center justify-center">
                                    <i class="fa-solid fa-plus text-xs text-brand-gold"></i>
                                </div>
                            </div>
                            <h3 class="font-display font-bold text-lg text-brand-dark mb-1">Your cart is empty</h3>
                            <p class="text-sm text-gray-500 mb-4">Add some delicious food to get started!</p>
                            <button onclick="scrollToMenu()" class="px-4 py-2 bg-gradient-to-r from-brand-red to-[#9A3120] text-white text-sm font-bold rounded-full hover:shadow-lg transition-all hover:-translate-y-0.5">
                                <i class="fa-solid fa-utensils mr-2"></i>Browse Menu
                            </button>
                        </div>
                    </div>

                    <!-- Cart Footer / Checkout (Scrollable part) -->
                    <div class="bg-gradient-to-b from-white to-gray-50 p-5 border-t border-gray-200/50">
                        <!-- Order Summary -->
                        <div class="bg-white rounded-xl p-4 mb-4 shadow-sm border border-gray-100">
                            <h3 class="font-display font-bold text-brand-dark mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-receipt text-brand-red"></i>
                                Order Summary
                            </h3>
                            
                            <div class="space-y-2 mb-3">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600">Subtotal</span>
                                    <span class="font-semibold" id="cart-subtotal">₹0</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600">Delivery Fee</span>
                                    <span class="font-semibold">₹0</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600">Taxes</span>
                                    <span class="font-semibold">₹0</span>
                                </div>
                            </div>
                            
                            <div class="border-t border-dashed border-gray-200 pt-3">
                                <div class="flex justify-between items-center text-lg font-display font-bold text-brand-dark">
                                    <span>Total Amount</span>
                                    <span id="cart-total" class="text-brand-red">₹0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Details Section -->
                        <div id="customer-section" class="space-y-4">
                            <!-- Customer Status -->
                            <div class="bg-gradient-to-r from-gray-50 to-white border border-gray-200 rounded-xl p-3 flex items-center justify-between shadow-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 bg-gradient-to-br from-brand-red/10 to-brand-red/5 rounded-full flex items-center justify-center">
                                        <i class="fa-solid fa-user text-xs text-brand-red"></i>
                                    </div>
                                    <div>
                                        <div class="text-xs font-medium text-gray-500">Customer Status</div>
                                        <div id="customer-status" class="text-sm font-bold text-brand-dark">NEW CUSTOMER</div>
                                    </div>
                                </div>
                                <div id="customer-found-badge" class="hidden">
                                    <div class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1">
                                        <i class="fa-solid fa-circle-check"></i>
                                        Returning
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Phone Input -->
                            <div class="relative group">
                                <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 group-focus-within:text-brand-red transition">
                                    <i class="fa-solid fa-phone text-sm"></i>
                                </div>
                                <input type="tel" id="cust-phone" onkeyup="checkCustomer()" placeholder="Mobile Number" 
                                       class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-red/30 focus:border-brand-red text-sm transition-all bg-white">
                            </div>
                            
                            <!-- Name Input -->
                            <div class="relative group">
                                <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 group-focus-within:text-brand-red transition">
                                    <i class="fa-solid fa-user text-sm"></i>
                                </div>
                                <input type="text" id="cust-name" placeholder="Your Name" 
                                       class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-red/30 focus:border-brand-red text-sm transition-all bg-white">
                            </div>
                            
                            <!-- Address/Notes -->
                            <div class="relative group">
                                <div class="absolute left-3 top-3 text-gray-400 group-focus-within:text-brand-red transition">
                                    <i class="fa-solid fa-location-dot text-sm"></i>
                                </div>
                                <textarea id="cust-note" placeholder="Complete Delivery Address" rows="2" 
                                          class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-red/30 focus:border-brand-red text-sm transition-all bg-white resize-none"></textarea>
                            </div>
                            
                            <!-- Secure Payment Note -->
                            <div class="text-center pt-2 pb-4">
                                <p class="text-xs text-gray-500 flex items-center justify-center gap-1">
                                    <i class="fa-solid fa-shield-check text-green-500"></i>
                                    100% Secure Payment • COD Available
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fixed Checkout Button (Mobile Only) -->
                <div class="md:hidden bg-gradient-to-t from-white to-white/95 border-t border-gray-200 p-4 shrink-0 sticky bottom-0 z-10">
                    <button onclick="placeOrder()" id="checkout-btn" 
                            class="w-full bg-gradient-to-r from-brand-red to-[#9A3120] text-white py-4 rounded-xl font-bold hover:shadow-xl transition-all duration-300 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none flex items-center justify-center gap-2 group">
                        <i class="fa-solid fa-bolt text-sm group-hover:animate-pulse"></i>
                        <span>PLACE ORDER NOW</span>
                        <i class="fa-solid fa-arrow-right text-sm group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>

                <!-- Desktop Checkout Button -->
                <div class="hidden md:block bg-gradient-to-t from-white to-white/95 border-t border-gray-200 p-5 shrink-0">
                    <button onclick="placeOrder()" id="desktop-checkout-btn"
                            class="w-full bg-gradient-to-r from-brand-red to-[#9A3120] text-white py-4 rounded-xl font-bold hover:shadow-xl transition-all duration-300 hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none flex items-center justify-center gap-3 group">
                        <i class="fa-solid fa-bolt text-sm group-hover:animate-pulse"></i>
                        <span class="text-lg">PLACE ORDER NOW</span>
                        <i class="fa-solid fa-arrow-right text-sm group-hover:translate-x-1 transition-transform"></i>
                    </button>
                    <p class="text-xs text-gray-500 text-center mt-3 flex items-center justify-center gap-1">
                        <i class="fa-solid fa-shield-check text-green-500"></i>
                        100% Secure • COD Available
                    </p>
                </div>
            </div>
        </aside>

        <!-- Mobile Cart Toggle Button (Floating) -->
        <div class="fixed bottom-6 right-6 z-40 md:hidden">
            <button onclick="toggleCart()" class="bg-gradient-to-r from-brand-red to-[#9A3120] text-white p-5 rounded-full shadow-2xl flex items-center gap-3 hover:shadow-3xl transition-all duration-300 hover:scale-105 group">
                <div class="relative">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                        <img src="asset/bucket icon.svg" alt="Cart" class="h-6 w-6">
                    </div>
                    <span id="mobile-cart-badge" class="absolute -top-1 -right-1 bg-brand-gold text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center shadow-lg transform scale-0 transition-transform duration-200">0</span>
                </div>
                <div class="text-left">
                    <div class="text-xs font-medium opacity-90">Your Order</div>
                    <div class="font-bold text-lg" id="mobile-cart-total">₹0</div>
                </div>
                <i class="fa-solid fa-chevron-up text-sm opacity-70 group-hover:translate-y-1 transition-transform"></i>
            </button>
        </div>

    </main>

    <!-- Portion Selection Modal -->
    <div id="portionModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold font-display text-brand-dark mb-2">Select Portion</h2>
                <p class="text-gray-500 text-sm" id="portion-item-name">Choose your preferred portion size</p>
            </div>
            
            <div class="space-y-3 mb-6" id="portion-options">
                <!-- Portion options will be injected here -->
            </div>
            
            <div class="flex gap-3">
                <button onclick="closePortionModal()" class="flex-1 px-4 py-3 border border-gray-300 text-gray-600 rounded-xl hover:bg-gray-50 font-medium transition">
                    Cancel
                </button>
                <button onclick="addSelectedPortionToCart()" id="add-to-cart-btn" class="flex-1 px-4 py-3 bg-brand-red text-white rounded-xl hover:bg-[#9A3120] font-bold transition">
                    Add to Cart
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="orderSuccessModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-8 max-w-sm w-full text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-check text-green-600 text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold font-display text-gray-800 mb-2">Order Placed!</h2>
              <p class="text-gray-600 mb-6">Your order #<span id="success-order-id" class="font-mono font-bold"></span> has been received.</p>
              <button onclick="trackCurrentOrder()" class="w-full bg-brand-dark text-white py-3 rounded-xl hover:bg-gray-800 font-bold mb-2">
                  Track Status
              </button>
              <button onclick="location.reload()" class="w-full bg-white border border-gray-300 text-gray-700 py-3 rounded-xl font-bold">
                  Place Another Order
              </button>
        </div>
    </div>


    <!-- Footer -->
    <footer class="bg-brand-dark text-white py-8 border-t border-gray-800">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <div class="font-display font-bold text-2xl mb-2">DCB</div>
            <p class="text-gray-400 text-sm mb-4">An Authentic Taste Legacy from Delhi</p>
            <p class="text-gray-600 text-xs">&copy; 2025 Delhi Chicken Brothers (DCB). All rights reserved.</p>
        </div>
    </footer>

    <!-- Logic -->
    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://kjbelegkbusvtvtcgwhq.supabase.co';
        // Note: In a production environment, never expose service keys. 
        // Using the Anon key provided for client-side operations.
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtqYmVsZWdrYnVzdnR2dGNnd2hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MjI5ODIsImV4cCI6MjA3NDA5ODk4Mn0.-K-rkuJnyDPL5YnkJ62-UG1_mG0BIILMUEZpSTNnq5M';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Meta CAPI Configuration
        const META_PIXEL_ID = '848998828089233';
        const CAPI_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/send-meta-capi`; // <-- CORRECT CAPI URL

        // --- STATE ---
        let state = {
            menu: [],
            cart: [],
            categories: [],
            activeCategory: 'All',
            isLoading: true,
            selectedItem: null,
            selectedPortion: null
        };

        let currentOrderId = null;

        // --- MENU DATA (For Seeding) ---
        // Transcribed from the uploaded image
        const SEED_DATA = [
            // Roasted
            { name: 'Juicy Chicken Kebab (Creamy)', category: 'ROASTED', description: 'Melt in mouth creamy kebab', prices: { 'Half (1 seekh)': 119, 'Full (2 seekh)': 199 } },
            { name: 'Minced Mutton Kebab (Creamy)', category: 'ROASTED', description: 'Rich mutton mince kebab', prices: { 'Half (1 seekh)': 159, 'Full (2 seekh)': 239 } },
            { name: 'Spicy Roasted Tangdi (Creamy)', category: 'ROASTED', description: 'Spicy roasted drumsticks', prices: { '2 pcs': 149, '4 pcs': 249 } },
            { name: 'Spicy Chicken Tikka (Dry)', category: 'ROASTED', description: 'Classic spicy tikka', prices: { '4 pcs': 199, '8 pcs': 299 } },
            { name: 'Chicken Malai Tikka (Creamy)', category: 'ROASTED', description: 'Mild creamy tikka', prices: { '4 pcs': 219, '8 pcs': 339 } },
            { name: 'Slurpy Afghani Chicken (Creamy)', category: 'ROASTED', description: 'Rich afghani sauce', prices: { '4 pcs': 259, '8 pcs': 359 } },
            { name: 'Chicken Salad Tikka (Creamy)', category: 'ROASTED', description: 'Healthy twist', prices: { '4 pcs': 239, '8 pcs': 299 } },
            { name: 'Tandoori Chicken (Dry)', category: 'ROASTED', description: 'Traditional clay oven roast', prices: { '4 pcs': 239, '8 pcs': 329 } },
            
            // Fried
            { name: 'Chicken Lollypop Spicy', category: 'FRIED', description: 'Spicy fried wings', prices: { '4 pcs': 239, '8 pcs': 349 } },
            { name: 'Spicy Fried Chicken', category: 'FRIED', description: 'Crispy spicy chicken', prices: { '4 pcs': 229, '8 pcs': 349 } },
            { name: 'Crispy Fried Tangdi', category: 'FRIED', description: 'Crunchy drumsticks', prices: { '2 pcs': 149, '4 pcs': 249 } },
            { name: 'Chicken Makkhni (Creamy)', category: 'FRIED', description: 'Buttery fried delight', prices: { '4 pcs': 259, '8 pcs': 399 } },
            { name: 'Crispy Fish Fry', category: 'FRIED', description: 'Golden fried fish', prices: { '2 pcs': 259, '4 pcs': 399 } },

            // Rolls
            { name: 'Chicken Tikka Roll', category: 'ROLLS', description: 'Wrapped in fresh bread', prices: { 'Standard': 139 } },
            { name: 'Chicken Kebab Roll', category: 'ROLLS', description: 'Juicy kebab wrap', prices: { 'Standard': 139 } },
            { name: 'Mutton Kebab Roll', category: 'ROLLS', description: 'Spicy mutton wrap', prices: { 'Standard': 179 } },
            
            // Breads
            { name: 'Roomali Roti', category: 'BREADS', description: 'Soft handkerchief bread', prices: { 'Per pc': 12 } },

            // Meal/Gravy
            { name: 'Chicken Korma', category: 'GRAVY', description: 'Rich spicy curry', prices: { 'Half (2 pcs)': 229, 'Full (5 pcs)': 399 } },
            { name: 'Butter Chicken', category: 'GRAVY', description: 'Classic creamy tomato gravy', prices: { 'Half (2 pcs)': 229, 'Full (5 pcs)': 399 } },
            { name: 'Spicy Chicken Curry', category: 'GRAVY', description: 'Homestyle curry', prices: { 'Half (2 pcs)': 199, 'Full (5 pcs)': 379 } },
            { name: 'Mughlai Chicken Biryani', category: 'GRAVY', description: 'Aromatic rice dish', prices: { 'Half (2 pcs)': 199, 'Full (5 pcs)': 379 } },
            { name: 'Egg Curry', category: 'GRAVY', description: 'Spicy egg gravy', prices: { '2 eggs': 119, '4 eggs': 199 } }
        ];

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchMenu();
            
            // Add popstate listener for back button support on mobile
            window.addEventListener('popstate', (event) => {
                const sidebar = document.getElementById('cart-sidebar');
                // Check if we're handling a cart state change
                if (event.state && event.state.cartOpen === false) {
                    // This is a state we pushed when closing cart, ignore it
                    return;
                }
                if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('hidden')) {
                    // Cart is open and back button was pressed - close it
                    sidebar.classList.add('translate-x-full');
                    setTimeout(() => sidebar.classList.add('hidden'), 300);
                }
            });

            // Check and request location permission
            checkLocationPermission();
        });

        // --- DB FUNCTIONS ---

        async function fetchMenu() {
            try {
                const { data, error } = await supabase.from('menu_items').select('*');
                
                if (error) throw error;

                if (!data || data.length === 0) {
                    // Database is empty, trigger seed modal
                    document.getElementById('seedModal').classList.remove('hidden');
                    // Use seed data locally for preview
                    processMenuData(SEED_DATA, true); 
                } else {
                    processMenuData(data, false);
                }
            } catch (err) {
                console.error('Error fetching menu:', err);
                // Fallback to local data if DB fails so site still looks good
                processMenuData(SEED_DATA, true);
                alert("Could not connect to live menu. Using offline mode.");
            }
        }

        async function seedDatabase() {
            const btn = document.querySelector('#seedModal button.bg-brand-red');
            const status = document.getElementById('seedStatus');
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Uploading...';
            btn.disabled = true;

            try {
                // Map local seed data to DB schema
                const records = SEED_DATA.map(item => ({
                    name: item.name,
                    category: item.category,
                    prices: item.prices,
                    description: item.description,
                    in_stock: true,
                    image_url: null // Or add placeholder URLs if desired
                }));

                const { data, error } = await supabase.from('menu_items').insert(records);
                
                if (error) throw error;

                status.innerText = "Success! Reloading...";
                status.className = "mt-4 text-green-600 font-bold";
                setTimeout(() => location.reload(), 1000);

            } catch (err) {
                console.error("Seeding failed", err);
                status.innerText = "Error: Check console. You might need to enable RLS policies or use a service key.";
                status.className = "mt-4 text-red-600 font-bold";
                btn.innerHTML = 'Try Again';
                btn.disabled = false;
            }
        }

        function closeSeedModal() {
            document.getElementById('seedModal').classList.add('hidden');
        }

        // --- DATA PROCESSING & RENDERING ---

        function processMenuData(data, isLocal) {
            // Normalize categories: trim whitespace and convert to uppercase for consistency
            state.menu = data.map(item => ({
                ...item,
                category: item.category.trim().toUpperCase()
            }));
            // Extract unique categories from normalized data
            const cats = new Set(state.menu.map(item => item.category));
            state.categories = ['All', ...Array.from(cats)];
            
            renderCategories();
            renderMenuGrid();
        }

        function renderCategories() {
            const container = document.getElementById('category-filters');
            container.innerHTML = state.categories.map(cat => `
                <button 
                    onclick="setCategory('${cat}')"
                    class="px-5 py-2 rounded-full text-sm font-bold uppercase tracking-wider transition whitespace-nowrap
                    ${state.activeCategory === cat 
                        ? 'bg-brand-red text-white shadow-md transform scale-105' 
                        : 'bg-white text-gray-600 hover:bg-gray-200 border border-gray-200'}"
                >
                    ${cat}
                </button>
            `).join('');
        }

        function setCategory(cat) {
            state.activeCategory = cat;
            renderCategories(); // Re-render to update active style
            renderMenuGrid();
        }

        function renderMenuGrid() {
            const container = document.getElementById('menu-grid');
            const filtered = state.activeCategory === 'All' 
                ? state.menu 
                : state.menu.filter(item => item.category === state.activeCategory);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-10 text-gray-400">No items found in this category.</div>`;
                return;
            }

            container.innerHTML = filtered.map((item, index) => {
                // Determine prices (handle JSONB format)
                const priceKeys = Object.keys(item.prices);
                const basePrice = item.prices[priceKeys[0]];

                return `
                <div class="bg-white rounded-xl shadow-sm hover:shadow-lg transition border border-gray-100 overflow-hidden flex flex-col group">
                    <div class="h-48 overflow-hidden bg-gray-100 relative">
                        <!-- Placeholder Image Logic -->
                        <div class="absolute inset-0 flex items-center justify-center text-gray-300 bg-gray-100">
                            <i class="fa-solid fa-drumstick-bite text-4xl"></i>
                        </div>
                        <img src="${item.image_url || `https://source.unsplash.com/400x300/?${item.category.toLowerCase()},food`}" 
                             onerror="this.style.display='none'"
                             alt="${item.name}" 
                             class="w-full h-full object-cover transform group-hover:scale-110 transition duration-500 relative z-10"
                        >
                        ${!item.in_stock ? '<div class="absolute inset-0 bg-white bg-opacity-80 z-20 flex items-center justify-center font-bold text-gray-500">OUT OF STOCK</div>' : ''}
                    </div>
                    
                    <div class="p-5 flex-1 flex flex-col">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-bold font-display text-brand-dark leading-tight">${item.name}</h3>
                            <span class="text-xs font-bold px-2 py-1 bg-gray-100 text-gray-500 rounded">${item.category}</span>
                        </div>
                        <p class="text-gray-500 text-sm mb-4 line-clamp-2">${item.description || 'Authentic delhi taste.'}</p>
                        
                        <div class="mt-auto pt-4 border-t border-dashed border-gray-200">
                            <div class="flex justify-center">
                                <button 
                                    onclick="openPortionModal('${item.id || item.name}', ${index})"
                                    ${!item.in_stock ? 'disabled' : ''}
                                    class="bg-brand-red text-white px-6 py-3 rounded-full font-bold hover:bg-[#9A3120] transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transform hover:-translate-y-1"
                                >
                                    <i class="fa-solid fa-utensils text-sm"></i>
                                    Select Portion
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // --- CART LOGIC ---

        function addToCart(itemId, index) {
            // Find item by ID or Name (fallback for local data which might not have UUIDs yet)
            const item = state.menu.find(i => (i.id === itemId) || (i.name === itemId));
            const variantSelect = document.getElementById(`variant-${index}`);
            const variantName = variantSelect.value;
            const price = item.prices[variantName];

            // Check if item+variant already in cart
            const existing = state.cart.find(c => c.name === item.name && c.variant === variantName);

            if (existing) {
                existing.quantity++;
            } else {
                // Create fallback image URL similar to menu grid
                const fallbackImage = item.image_url || 
                    `https://source.unsplash.com/400x300/?${item.category ? item.category.toLowerCase() : 'food'},food`;
                
                state.cart.push({
                    id: item.id, // Might be undefined if local seed, handled later
                    name: item.name,
                    variant: variantName,
                    price: price,
                    quantity: 1,
                    image: fallbackImage
                });
            }

            saveCartToMemory();
            renderCart();
            animateCartBadge();
        }

        function removeFromCart(cartIndex) {
            state.cart.splice(cartIndex, 1);
            renderCart();
        }

        function updateQuantity(cartIndex, change) {
            const item = state.cart[cartIndex];
            item.quantity += change;
            if (item.quantity <= 0) {
                removeFromCart(cartIndex);
            } else {
                renderCart();
            }
        }

        // --- LOCAL STORAGE FUNCTIONS ---

        function saveCartToMemory() {
            localStorage.setItem('dcb_cart', JSON.stringify(state.cart));
        }

        function loadCartFromMemory() {
            const savedCart = localStorage.getItem('dcb_cart');
            if (savedCart) {
                try {
                    state.cart = JSON.parse(savedCart);
                    // Re-render immediately so user sees items
                    renderCart();
                    animateCartBadge();
                } catch (e) {
                    console.error("Error loading cart", e);
                    localStorage.removeItem('dcb_cart'); // Clear corrupt data
                }
            }
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            const subtotalEl = document.getElementById('cart-subtotal');
            const totalEl = document.getElementById('cart-total');
            const totalMobile = document.getElementById('mobile-cart-total');
            const badges = document.querySelectorAll('#cart-badge, #mobile-cart-badge');
            const checkoutBtn = document.getElementById('checkout-btn');

            if (state.cart.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-48 text-gray-500">
                        <div class="relative mb-4">
                            <div class="w-20 h-20 bg-gradient-to-br from-brand-cream to-white rounded-full flex items-center justify-center shadow-inner">
                                <i class="fa-solid fa-burger text-3xl text-brand-red/50"></i>
                            </div>
                            <div class="absolute -top-2 -right-2 w-10 h-10 bg-brand-gold/20 rounded-full flex items-center justify-center">
                                <i class="fa-solid fa-plus text-xs text-brand-gold"></i>
                            </div>
                        </div>
                        <h3 class="font-display font-bold text-lg text-brand-dark mb-1">Your cart is empty</h3>
                        <p class="text-sm text-gray-500 mb-4">Add some delicious food to get started!</p>
                        <button onclick="scrollToMenu()" class="px-4 py-2 bg-gradient-to-r from-brand-red to-[#9A3120] text-white text-sm font-bold rounded-full hover:shadow-lg transition-all hover:-translate-y-0.5">
                            <i class="fa-solid fa-utensils mr-2"></i>Browse Menu
                        </button>
                    </div>`;
                subtotalEl.innerText = '₹0';
                totalEl.innerText = '₹0';
                totalMobile.innerText = '₹0';
                badges.forEach(b => { b.innerText = '0'; b.classList.add('scale-0'); });
                checkoutBtn.disabled = true;
                return;
            }

            // Calculate totals
            const subtotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            // GST is already included in menu prices (5% inclusive)
            // Calculate GST amount included in subtotal: GST = subtotal * (5/105) ≈ subtotal * 0.047619
            const gstIncluded = Math.round(subtotal * (5/105));
            const deliveryFee = subtotal < 499 ? 55 : 0; // ₹55 delivery if subtotal < 499
            const total = subtotal + deliveryFee; // No extra GST added - already included in subtotal

            // Update UI
            subtotalEl.innerText = '₹' + subtotal;
            totalEl.innerText = '₹' + total;
            totalMobile.innerText = '₹' + total;
            
            // Update delivery fee and taxes display
            const orderSummary = document.querySelector('.bg-white.rounded-xl.p-4.mb-4');
            if (orderSummary) {
                const deliveryFeeLabel = orderSummary.querySelector('div.space-y-2 > div:nth-child(2) .text-gray-600');
                const taxesLabel = orderSummary.querySelector('div.space-y-2 > div:nth-child(3) .text-gray-600');
                const deliveryFeeSpan = orderSummary.querySelector('div.space-y-2 > div:nth-child(2) .font-semibold');
                const taxesSpan = orderSummary.querySelector('div.space-y-2 > div:nth-child(3) .font-semibold');
                
                if (deliveryFeeLabel) {
                    deliveryFeeLabel.innerText = deliveryFee > 0 ? 'Delivery Fee (value is less than 499)' : 'Delivery Fee';
                }
                if (taxesLabel) {
                    taxesLabel.innerText = 'Taxes (GST 5%, we bear the cost!)';
                }
                if (deliveryFeeSpan) {
                    deliveryFeeSpan.innerText = `₹${deliveryFee}`;
                }
                if (taxesSpan) {
                    taxesSpan.innerText = `₹${gstIncluded}`;
                }
            }
            
            const count = state.cart.reduce((acc, item) => acc + item.quantity, 0);
            badges.forEach(b => { 
                b.innerText = count; 
                b.classList.remove('scale-0'); 
            });

            checkoutBtn.disabled = false;

            // Render Items
            container.innerHTML = state.cart.map((item, idx) => `
                <div class="bg-gradient-to-br from-white to-gray-50 rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-200 group">
                    <div class="flex items-start gap-4">
                        <!-- Item Image -->
                        <div class="w-14 h-14 bg-gradient-to-br from-brand-cream to-white rounded-lg flex items-center justify-center shadow-inner flex-shrink-0 overflow-hidden">
                            ${item.image ? 
                                `<img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover" onerror="this.style.display='none'" />` :
                                `<i class="fa-solid fa-drumstick-bite text-xl text-brand-red/70"></i>`
                            }
                        </div>
                        
                        <!-- Item Details -->
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="font-bold text-brand-dark text-sm leading-tight truncate">${item.name}</h4>
                                <button onclick="removeFromCart(${idx})" class="text-gray-400 hover:text-red-500 transition ml-2 flex-shrink-0" title="Remove item">
                                    <i class="fa-solid fa-times text-xs"></i>
                                </button>
                            </div>
                            <div class="text-xs text-gray-500 mb-2 bg-gray-50 px-2 py-1 rounded inline-block">${item.variant}</div>
                            
                            <div class="flex items-center justify-between mt-3">
                                <!-- Price -->
                                <div class="font-bold text-brand-red text-lg">₹${item.price * item.quantity}</div>
                                
                                <!-- Quantity Controls -->
                                <div class="flex items-center bg-white border border-gray-200 rounded-lg px-2 py-1 shadow-sm">
                                    <button onclick="updateQuantity(${idx}, -1)" class="w-6 h-6 flex items-center justify-center text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition" title="Decrease quantity">
                                        <i class="fa-solid fa-minus text-xs"></i>
                                    </button>
                                    <span class="text-sm font-bold text-brand-dark mx-3 min-w-[20px] text-center">${item.quantity}</span>
                                    <button onclick="updateQuantity(${idx}, 1)" class="w-6 h-6 flex items-center justify-center text-gray-600 hover:text-green-600 hover:bg-green-50 rounded transition" title="Increase quantity">
                                        <i class="fa-solid fa-plus text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Unit Price -->
                            <div class="text-xs text-gray-500 mt-2 text-right">
                                ₹${item.price} per unit
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleCart() {
            const sidebar = document.getElementById('cart-sidebar');
            console.log('toggleCart called, sidebar:', sidebar);
            // Toggle classes to slide in/out or show/hide based on mobile/desktop
            if (window.innerWidth < 768) {
                // Mobile behavior (Drawer)
                if (sidebar.classList.contains('hidden')) {
                    console.log('Opening mobile cart');
                    sidebar.classList.remove('hidden');
                    setTimeout(() => sidebar.classList.remove('translate-x-full'), 10);
                    
                    // Push state to history for back button support
                    history.pushState({ cartOpen: true }, '', '#cart');
                } else {
                    console.log('Closing mobile cart');
                    sidebar.classList.add('translate-x-full');
                    setTimeout(() => sidebar.classList.add('hidden'), 300);
                    
                    // Push a false state when closing to prevent back button from reopening
                    history.pushState({ cartOpen: false }, '', window.location.pathname);
                }
            } else {
                // Desktop - Just scroll to it or highlight (it's always visible in layout)
                // If using hidden implementation on desktop:
                console.log('Toggling desktop cart visibility');
                sidebar.classList.toggle('hidden');
            }
        }

        function animateCartBadge() {
            const badge = document.getElementById('cart-badge');
            badge.classList.add('animate-bounce-short');
            setTimeout(() => badge.classList.remove('animate-bounce-short'), 600);
        }

        function scrollToMenu() {
            document.getElementById('category-filters').scrollIntoView({ behavior: 'smooth' });
        }

        // --- PORTION SELECTION FUNCTIONS ---

        function openPortionModal(itemId, index) {
            // Find item by ID or Name
            const item = state.menu.find(i => (i.id === itemId) || (i.name === itemId));
            state.selectedItem = item;
            state.selectedPortion = null;

            // Update modal title
            document.getElementById('portion-item-name').innerText = item.name;

            // Render portion options
            const optionsContainer = document.getElementById('portion-options');
            const priceKeys = Object.keys(item.prices);
            
            optionsContainer.innerHTML = priceKeys.map((key, idx) => {
                const price = item.prices[key];
                const isSelected = idx === 0; // Select first option by default
                if (isSelected) state.selectedPortion = key;
                
                return `
                <div class="portion-option ${isSelected ? 'selected' : ''}" onclick="selectPortion('${key}')">
                    <div class="flex items-center justify-between p-4 border-2 rounded-xl cursor-pointer transition-all duration-200 ${isSelected ? 'border-brand-red bg-red-50' : 'border-gray-200 hover:border-gray-300'}">
                        <div class="flex-1">
                            <div class="font-bold text-brand-dark">${key}</div>
                            <div class="text-sm text-gray-500">${getPortionDescription(key)}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-brand-red text-lg">₹${price}</div>
                            ${isSelected ? '<i class="fa-solid fa-check text-brand-red ml-2"></i>' : ''}
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // Enable/disable add to cart button
            document.getElementById('add-to-cart-btn').disabled = !state.selectedPortion;

            // Meta Pixel Tracking: ViewContent (Product View)
            try {
                if (typeof fbq === 'function') {
                    fbq('track', 'ViewContent', {
                        content_name: item.name,
                        content_ids: [item.id], // Use the unique ID from Supabase
                        content_type: 'product',
                        currency: 'INR',
                        value: item.prices[Object.keys(item.prices)[0]] // Base price
                    });
                }
            } catch (e) { console.error("Meta Pixel Error (ViewContent):", e); }
            
            // Also send to Meta CAPI
            trackViewContent(item);
            
            // Show modal
            document.getElementById('portionModal').classList.remove('hidden');
        }

        function selectPortion(portion) {
            state.selectedPortion = portion;
            
            // Update UI to show selected portion
            document.querySelectorAll('.portion-option').forEach(option => {
                const div = option.querySelector('div');
                if (option.getAttribute('onclick').includes(portion)) {
                    div.classList.remove('border-gray-200', 'hover:border-gray-300');
                    div.classList.add('border-brand-red', 'bg-red-50');
                    option.querySelector('.fa-check')?.remove();
                    div.querySelector('.text-right').innerHTML += '<i class="fa-solid fa-check text-brand-red ml-2"></i>';
                } else {
                    div.classList.remove('border-brand-red', 'bg-red-50');
                    div.classList.add('border-gray-200', 'hover:border-gray-300');
                    option.querySelector('.fa-check')?.remove();
                }
            });

            // Enable add to cart button
            document.getElementById('add-to-cart-btn').disabled = false;
        }

        function getPortionDescription(portion) {
            const descriptions = {
                'Half (1 seekh)': 'Perfect for one person',
                'Full (2 seekh)': 'Great for sharing',
                '2 pcs': 'Two delicious pieces',
                '4 pcs': 'Four generous pieces',
                '8 pcs': 'Eight pieces for the whole family',
                'Half (2 pcs)': 'Perfect portion for one',
                'Full (5 pcs)': 'Complete meal for one',
                'Standard': 'Regular serving size',
                'Per pc': 'Single piece',
                '2 eggs': 'Two egg serving',
                '4 eggs': 'Four egg serving'
            };
            return descriptions[portion] || 'Delicious portion';
        }

        function closePortionModal() {
            document.getElementById('portionModal').classList.add('hidden');
            state.selectedItem = null;
            state.selectedPortion = null;
        }

        function addSelectedPortionToCart() {
            if (!state.selectedItem || !state.selectedPortion) {
                alert('Please select a portion first');
                return;
            }

            const price = state.selectedItem.prices[state.selectedPortion];

            // Check if item+variant already in cart
            const existing = state.cart.find(c => c.name === state.selectedItem.name && c.variant === state.selectedPortion);

            if (existing) {
                existing.quantity++;
            } else {
                // Create fallback image URL similar to menu grid
                const fallbackImage = state.selectedItem.image_url ||
                    `https://source.unsplash.com/400x300/?${state.selectedItem.category ? state.selectedItem.category.toLowerCase() : 'food'},food`;
                
                state.cart.push({
                    id: state.selectedItem.id,
                    name: state.selectedItem.name,
                    variant: state.selectedPortion,
                    price: price,
                    quantity: 1,
                    image: fallbackImage
                });
            }

            // Meta Pixel Tracking: AddToCart
            try {
                if (typeof fbq === 'function') {
                    fbq('track', 'AddToCart', {
                        content_name: state.selectedItem.name,
                        content_ids: [state.selectedItem.id],
                        content_type: 'product',
                        currency: 'INR',
                        value: price // Value of the single item added
                    });
                }
            } catch (e) { console.error("Meta Pixel Error (AddToCart):", e); }
            
            // Also send to Meta CAPI
            trackAddToCart(state.selectedItem, state.selectedPortion, price);
            
            renderCart();
            animateCartBadge();
            closePortionModal();
            
            // Show success notification
            showNotification(`${state.selectedItem.name} (${state.selectedPortion}) added to cart!`, 'success');
        }

        function showNotification(message, type = 'info') {
            // Create a simple toast notification
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg font-bold transition-all duration-300 transform translate-x-full ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'
            }`;
            notification.innerText = message;
            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 10);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // --- CUSTOMER FUNCTIONS ---

        async function checkCustomer() {
            const phone = document.getElementById('cust-phone').value.replace(/\D/g,'');
            if (phone.length === 10) {
                const { data, error } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('phone', phone)
                    .single();
                
                if (data) {
                    // Customer found - auto-fill details
                    document.getElementById('cust-name').value = data.name || data.first_name || '';
                    document.getElementById('customer-status').innerText = "LOYAL CUSTOMER";
                    document.getElementById('customer-status').className = "text-xs text-green-700 font-bold";
                    document.getElementById('customer-found-badge').classList.remove('hidden');
                    document.getElementById('customer-found-badge').innerHTML = `
                        <div class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1">
                            <i class="fa-solid fa-circle-check"></i>
                            Welcome Back Again
                        </div>`;
                    
                    // Show notification
                    showNotification(`Welcome back again, ${data.name || data.first_name}!`, 'success');
                } else {
                    // New customer
                    document.getElementById('customer-status').innerText = "NEW CUSTOMER";
                    document.getElementById('customer-status').className = "text-xs text-gray-700";
                    document.getElementById('customer-found-badge').classList.add('hidden');
                }
            } else {
                // Reset if phone is incomplete
                document.getElementById('customer-status').innerText = "NEW CUSTOMER";
                document.getElementById('customer-status').className = "text-xs text-gray-700";
                document.getElementById('customer-found-badge').classList.add('hidden');
            }
        }

        // --- ORDER SUBMISSION ---

        async function placeOrder() {
            const phone = document.getElementById('cust-phone').value.replace(/\D/g,'');
            const name = document.getElementById('cust-name').value.trim();
            const note = document.getElementById('cust-note').value.trim();
            const btn = document.getElementById('checkout-btn');

            // Validation
            if (state.cart.length === 0) {
                alert("Your cart is empty! Add items first.");
                return;
            }
            if (!phone || phone.length < 10) {
                alert("Please enter a valid 10-digit phone number.");
                return;
            }
            if (!name) {
                alert("Please enter your name.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

            try {
                // 1. Find or Create Customer
                let customerId;
                let { data: existingCustomer } = await supabase
                    .from('customers')
                    .select('id, name')
                    .eq('phone', phone)
                    .single();
                
                if (existingCustomer) {
                    // Existing customer - update name if changed
                    customerId = existingCustomer.id;
                    if (name !== existingCustomer.name) {
                        await supabase
                            .from('customers')
                            .update({ name: name })
                            .eq('id', customerId);
                    }
                    // No need to update total_orders - it can be calculated from orders table
                } else {
                    // New customer
                    const { data: newCustomer, error: createError } = await supabase
                        .from('customers')
                        .insert([{ 
                            name: name, 
                            phone: phone
                        }])
                        .select()
                        .single();
                    
                    if (createError) throw new Error("Database error saving customer: " + createError.message);
                    customerId = newCustomer.id;
                }

                // 2. Capture location for online orders
                let latitude = null;
                let longitude = null;
                
                // Try to get stored location from sessionStorage
                const storedLocation = getStoredLocation();
                if (storedLocation) {
                    latitude = storedLocation.latitude;
                    longitude = storedLocation.longitude;
                    console.log(`Online order location captured: ${latitude}, ${longitude}`);
                } else {
                    // If no stored location, try to get current location
                    try {
                        const position = await getCurrentPosition();
                        latitude = position.coords.latitude;
                        longitude = position.coords.longitude;
                        console.log(`Online order location captured (real-time): ${latitude}, ${longitude}`);
                    } catch (locationError) {
                        console.warn("Could not capture location for online order:", locationError);
                        // Continue without location
                    }
                }

                // 3. Prepare Order Data
                const subtotal = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                // GST is already included in menu prices (5% inclusive)
                // Calculate GST amount included in subtotal: GST = subtotal * (5/105) ≈ subtotal * 0.047619
                const gstIncluded = Math.round(subtotal * (5/105));
                const deliveryFee = subtotal < 499 ? 55 : 0; // ₹55 delivery if subtotal < 499
                const grandTotal = subtotal + deliveryFee; // No extra GST added - already included in subtotal
                
                // Prepare data for Meta Pixel Purchase Event
                const pixelContentIds = state.cart.map(item => item.id); // Array of product IDs
                const pixelContent = state.cart.map(item => ({
                    id: item.id,
                    quantity: item.quantity
                }));
                
                // Log order breakdown for debugging
                console.log(`Order breakdown: Subtotal: ₹${subtotal} (includes GST: ₹${gstIncluded}), Delivery: ₹${deliveryFee}, Total: ₹${grandTotal}`);
                
                // 4. Create Order Data with location (for online orders)
                const orderData = {
                    customer_id: customerId,
                    items: state.cart,
                    total_amount: grandTotal, 
                    order_type: 'Delivery',
                    payment_method: 'COD',
                    status: 'pending',
                    note: note
                };

                // Add location data if available (for online orders)
                if (latitude !== null && longitude !== null) {
                    orderData.latitude = latitude;
                    orderData.longitude = longitude;
                }

                const { data: orderDataResult, error: orderError } = await supabase
                    .from('orders')
                    .insert([orderData])
                    .select()
                    .single();

                if (orderError) throw orderError;

                // Meta Pixel Tracking: Purchase (Transaction Complete)
                try {
                    if (typeof fbq === 'function') {
                        fbq('track', 'Purchase', {
                            content_ids: pixelContentIds,
                            content_type: 'product',
                            contents: pixelContent,
                            currency: 'INR',
                            value: grandTotal // Use the final, all-inclusive price
                        }, {
                            eventID: 'Order_' + orderData.id // Unique ID for CAPI deduplication
                        });
                    }
                } catch (e) { console.error("Meta Pixel Error (Purchase):", e); }
                
                // **********************************************
                // 3. SEND CONVERSIONS API EVENT (Server-Side)
                // **********************************************
                const eventId = 'Order_' + orderData.id;

                const capiPayload = {
                    events: [{
                        event_name: 'Purchase',
                        event_id: eventId,
                        event_source_url: window.location.href,
                        event_time: Math.floor(Date.now() / 1000),
                        action_source: 'website',
                        user_data: {
                            // Unhashed data sent to server function for hashing
                            em: null, // No email collection, send null
                            ph: phone, 
                            fn: name.split(' ')[0],
                            ln: name.split(' ').slice(1).join(' '),
                            client_user_agent: navigator.userAgent // Browser details for matching
                        },
                        custom_data: {
                            value: grandTotal,
                            currency: 'INR',
                            content_ids: pixelContentIds,
                            contents: pixelContent,
                            num_items: state.cart.length
                        }
                    }]
                };

                // Call the Edge Function asynchronously (do not wait for it)
                fetch(CAPI_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(capiPayload)
                })
                .then(response => {
                    console.log("CAPI call sent. Server response status:", response.status);
                })
                .catch(error => {
                    console.error("CAPI call failed on client side:", error);
                });
                // **********************************************
                
                // 3. Success
                currentOrderId = orderDataResult.id; // Store the UUID
                document.getElementById('success-order-id').innerText = orderDataResult.order_number;
                document.getElementById('orderSuccessModal').classList.remove('hidden');

                // Clear cart and reset form (omitted for brevity)
                // ...
                
                // Clear cart
                state.cart = [];
                renderCart();

                // Reset form
                document.getElementById('cust-phone').value = '';
                document.getElementById('cust-name').value = '';
                document.getElementById('cust-note').value = '';
                document.getElementById('customer-status').innerText = "NEW CUSTOMER";
                document.getElementById('customer-status').className = "text-xs text-gray-700";
                document.getElementById('customer-found-badge').classList.add('hidden');

            } catch (err) {
                console.error("Order failed:", err);
                alert("Error placing order: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = 'PLACE ORDER';
            }
        }

        function trackCurrentOrder() {
            if (currentOrderId) {
                window.location.href = `order-status.html?id=${currentOrderId}`;
            }
        }

        // --- META CAPI UTILITY FUNCTIONS ---

        // Generate a unique event ID
        function generateEventId() {
            return 'event_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Get browser fingerprint for user identification
        function getBrowserFingerprint() {
            try {
                // Get fbp cookie (Facebook Browser ID)
                const fbpMatch = document.cookie.match(/_fbp=([^;]+)/);
                const fbp = fbpMatch ? fbpMatch[1] : null;
                
                // Get fbc cookie (Facebook Click ID)
                const fbcMatch = document.cookie.match(/_fbc=([^;]+)/);
                const fbc = fbcMatch ? fbcMatch[1] : null;
                
                return { fbp, fbc };
            } catch (e) {
                return { fbp: null, fbc: null };
            }
        }

        // Send event to Meta CAPI
        async function sendToMetaCAPI(eventName, eventData = {}, customData = {}) {
            try {
                const { fbp, fbc } = getBrowserFingerprint();
                const eventTime = Math.floor(Date.now() / 1000);
                const eventId = generateEventId();
                
                // Prepare user data
                const userData = {
                    client_ip_address: '{{client_ip}}', // Will be populated by Edge Function
                    client_user_agent: navigator.userAgent,
                    ...(fbp && { fbp }),
                    ...(fbc && { fbc })
                };

                // Prepare the event for Meta CAPI
                const metaEvent = {
                    event_name: eventName,
                    event_time: eventTime,
                    event_id: eventId,
                    event_source_url: window.location.href,
                    action_source: 'website',
                    user_data: userData,
                    custom_data: {
                        currency: 'INR',
                        ...customData
                    }
                };

                // Send to Supabase Edge Function
                const response = await fetch(CAPI_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        events: [metaEvent]
                    })
                });

                if (!response.ok) {
                    console.warn(`Meta CAPI event ${eventName} failed:`, await response.text());
                } else {
                    console.log(`Meta CAPI event ${eventName} sent successfully`);
                }
                
                return { success: response.ok, eventId };
            } catch (error) {
                console.error(`Error sending Meta CAPI event ${eventName}:`, error);
                return { success: false, error: error.message };
            }
        }

        // Track PageView with CAPI
        async function trackPageView() {
            // Already tracked by Meta Pixel in head, but also send to CAPI
            await sendToMetaCAPI('PageView');
        }

        // Track ViewContent with CAPI
        async function trackViewContent(item) {
            const customData = {
                content_name: item.name,
                content_ids: [item.id || item.name],
                content_type: 'product',
                value: item.prices[Object.keys(item.prices)[0]] || 0
            };
            
            await sendToMetaCAPI('ViewContent', {}, customData);
        }

        // Track AddToCart with CAPI
        async function trackAddToCart(item, portion, price) {
            const customData = {
                content_name: item.name,
                content_ids: [item.id || item.name],
                content_type: 'product',
                value: price,
                contents: [{
                    id: item.id || item.name,
                    quantity: 1
                }]
            };
            
            await sendToMetaCAPI('AddToCart', {}, customData);
        }

        // Track Purchase with CAPI
        async function trackPurchase(orderId, cartItems, totalValue) {
            const contents = cartItems.map(item => ({
                id: item.id || item.name,
                quantity: item.quantity
            }));
            
            const customData = {
                content_ids: cartItems.map(item => item.id || item.name),
                contents: contents,
                currency: 'INR',
                value: totalValue,
                order_id: orderId,
                num_items: cartItems.reduce((sum, item) => sum + item.quantity, 0)
            };
            
            await sendToMetaCAPI('Purchase', {}, customData);
        }

        // --- LOCATION PERMISSION FUNCTIONS ---

        function checkLocationPermission() {
            // Check if we've already asked for location in this session
            const locationAsked = sessionStorage.getItem('locationAsked');
            const locationGranted = sessionStorage.getItem('locationGranted');
            
            // If we haven't asked yet, show the modal after a short delay
            if (!locationAsked && !locationGranted) {
                setTimeout(() => {
                    document.getElementById('locationModal').classList.remove('hidden');
                }, 1000); // Show after 1 second
            }
        }

        function requestLocation() {
            const status = document.getElementById('locationStatus');
            status.innerText = "Requesting location...";
            status.className = "mt-4 text-blue-600 font-bold";
            
            // Mark that we've asked for location
            sessionStorage.setItem('locationAsked', 'true');
            
            if (!navigator.geolocation) {
                status.innerText = "Geolocation is not supported by your browser";
                status.className = "mt-4 text-red-600 font-bold";
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Success: Store coordinates in sessionStorage
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    
                    sessionStorage.setItem('userLatitude', latitude);
                    sessionStorage.setItem('userLongitude', longitude);
                    sessionStorage.setItem('locationGranted', 'true');
                    
                    status.innerText = "Location captured successfully!";
                    status.className = "mt-4 text-green-600 font-bold";
                    
                    // Close modal after 1 second
                    setTimeout(() => {
                        document.getElementById('locationModal').classList.add('hidden');
                        showNotification("Location captured successfully!", 'success');
                    }, 1000);
                    
                    // Log coordinates (for debugging)
                    console.log(`Location captured: ${latitude}, ${longitude}`);
                },
                (error) => {
                    // Error handling
                    let errorMessage = "Unable to retrieve your location";
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "Location permission denied. You can enable it in your browser settings.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "Location information is unavailable.";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "Location request timed out.";
                            break;
                    }
                    
                    status.innerText = errorMessage;
                    status.className = "mt-4 text-red-600 font-bold";
                    
                    // Still mark as asked
                    sessionStorage.setItem('locationAsked', 'true');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function denyLocation() {
            // Mark that we've asked for location
            sessionStorage.setItem('locationAsked', 'true');
            document.getElementById('locationModal').classList.add('hidden');
            showNotification("You can enable location access later in your browser settings.", 'info');
        }

        // Function to get stored location (if available)
        function getStoredLocation() {
            const lat = sessionStorage.getItem('userLatitude');
            const lng = sessionStorage.getItem('userLongitude');
            
            if (lat && lng) {
                return {
                    latitude: parseFloat(lat),
                    longitude: parseFloat(lng)
                };
            }
            return null;
        }

        // --- UTILITY FUNCTIONS ---

        // Function to handle image loading errors
        function handleImageError(img) {
            img.style.display = 'none';
        }

        // Function to format currency
        function formatCurrency(amount) {
            return '₹' + amount;
        }

        // Function to get cart item count
        function getCartItemCount() {
            return state.cart.reduce((acc, item) => acc + item.quantity, 0);
        }

        // Function to get cart total
        function getCartTotal() {
            return state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }

        // Function to validate phone number
        function isValidPhone(phone) {
            return /^\d{10}$/.test(phone);
        }

        // Function to show notification
        function showNotification(message, type = 'info') {
            // Simple notification implementation
            console.log(`${type.toUpperCase()}: ${message}`);
            // You can implement a proper toast notification here
        }

        // Helper function to get current position
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("Geolocation is not supported by your browser"));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    resolve,
                    reject,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

    </script>
</body>
</html>
