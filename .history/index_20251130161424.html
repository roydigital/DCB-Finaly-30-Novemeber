<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCB - Delhi Chicken Burger | Authentic Taste</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            red: '#D92323',
                            dark: '#1a1a1a',
                            cream: '#f4f1ea',
                            gold: '#f59e0b'
                        }
                    },
                    fontFamily: {
                        display: ['Oswald', 'sans-serif'],
                        body: ['Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #D92323; border-radius: 3px; }
        .animate-bounce-short { animation: bounce-short 0.3s ease-in-out 2 alternate; }
        @keyframes bounce-short { 0% { transform: translateY(0); } 100% { transform: translateY(-5px); } }
    </style>
</head>
<body class="bg-brand-cream text-gray-800 font-body antialiased">

    <nav class="sticky top-0 z-40 bg-white shadow-md border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-brand-red rounded-full flex items-center justify-center text-white font-bold font-display text-xl border-2 border-brand-dark">
                        DCB
                    </div>
                    <div class="hidden md:block">
                        <h1 class="text-xl font-bold font-display tracking-wide text-brand-dark leading-none">DELHI CHICKEN BURGER</h1>
                        <span class="text-xs text-brand-red font-medium tracking-widest uppercase">Authentic Taste Legacy</span>
                    </div>
                </div>

                <div class="flex items-center space-x-6">
                    <button onclick="openMyOrdersModal()" class="text-brand-dark hover:text-brand-red font-bold text-sm flex items-center gap-2">
                        <i class="fa-solid fa-clock-rotate-left"></i> <span class="hidden sm:inline">My Orders</span>
                    </button>
                    
                    <div class="relative cursor-pointer" onclick="toggleCart()">
                        <div class="p-2 hover:bg-gray-100 rounded-full transition">
                            <i class="fa-solid fa-bag-shopping text-2xl text-brand-dark"></i>
                        </div>
                        <span id="cart-badge" class="absolute top-0 right-0 bg-brand-red text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full transform scale-0 transition-transform duration-200">0</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="relative bg-brand-dark text-white overflow-hidden">
        <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1555939594-58d7cb561ad1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80')] bg-cover bg-center opacity-40"></div>
        <div class="relative max-w-7xl mx-auto py-20 px-4 text-center sm:text-left">
            <h1 class="text-4xl md:text-6xl font-display font-bold mb-4 tracking-tight">
                THE REAL <span class="text-brand-red">TASTE OF DELHI</span>
            </h1>
            <p class="text-xl text-gray-300 mb-8 max-w-2xl">
                Experience authentic roasted kebabs, creamy curries, and crunchy rolls. Directly from the grill to your doorstep.
            </p>
            <button onclick="scrollToMenu()" class="bg-brand-red hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:-translate-y-1">
                ORDER NOW
            </button>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 flex flex-col md:flex-row gap-8 relative">
        
        <div class="flex-1">
            <div class="sticky top-20 z-30 bg-brand-cream py-4 overflow-x-auto no-scrollbar">
                <div class="flex space-x-2" id="category-filters">
                    </div>
            </div>

            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 mt-6">
                <div class="text-center col-span-full py-10 text-gray-500">
                    <i class="fa-solid fa-spinner fa-spin text-3xl mb-3"></i>
                    <p>Loading delicious menu...</p>
                </div>
            </div>
        </div>

        <aside id="cart-sidebar" class="fixed inset-y-0 right-0 w-full sm:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 md:relative md:transform-none md:w-80 md:block md:translate-x-0 md:shadow-none md:bg-transparent hidden">
            <div class="h-full md:h-auto md:sticky md:top-24 bg-white md:rounded-xl md:shadow-lg overflow-hidden flex flex-col border border-gray-200">
                
                <div class="bg-brand-dark p-4 flex justify-between items-center text-white">
                    <h2 class="font-display text-xl font-bold"><i class="fa-solid fa-basket-shopping mr-2"></i> Your Order</h2>
                    <button class="md:hidden text-gray-300 hover:text-white" onclick="toggleCart()">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>

                <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-4 max-h-[50vh] min-h-[200px] bg-gray-50">
                    <div class="flex flex-col items-center justify-center h-48 text-gray-400">
                        <i class="fa-solid fa-burger text-4xl mb-2 opacity-50"></i>
                        <p>Your cart is empty</p>
                    </div>
                </div>

                <div class="bg-white p-4 border-t border-gray-200 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
                    <div class="flex justify-between mb-2 text-sm text-gray-600">
                        <span>Subtotal</span>
                        <span class="font-bold" id="cart-subtotal">₹0</span>
                    </div>
                    <div class="flex justify-between mb-4 text-xl font-display font-bold text-brand-dark border-b pb-2">
                        <span>Total</span>
                        <span id="cart-total">₹0</span>
                    </div>

                    <div class="space-y-3 mb-3">
                        <input type="tel" id="checkout-phone" placeholder="Mobile Number (Required)" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-brand-red focus:ring-1 focus:ring-brand-red text-sm font-bold bg-gray-50">
                        <input type="text" id="checkout-name" placeholder="Your Name" class="w-full px-3 py-2 border border-gray-300 rounded focus:border-brand-red focus:ring-1 focus:ring-brand-red text-sm">
                    </div>
                    
                    <button onclick="placeOrder()" id="checkout-btn" class="w-full bg-brand-green hover:bg-green-700 text-white py-3 rounded-lg font-bold shadow-lg transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                        PLACE ORDER
                    </button>
                </div>
            </div>
        </aside>

    </main>

    <div class="fixed bottom-4 right-4 z-40 md:hidden">
        <button onclick="toggleCart()" class="bg-brand-dark text-white p-4 rounded-full shadow-xl flex items-center gap-2 border-2 border-white">
            <div class="relative">
                <i class="fa-solid fa-bag-shopping text-xl"></i>
                <span id="mobile-cart-badge" class="absolute -top-2 -right-2 bg-brand-red text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">0</span>
            </div>
            <span class="font-bold" id="mobile-cart-total">₹0</span>
        </button>
    </div>

    <div id="myOrdersModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full shadow-2xl relative">
            <button onclick="closeMyOrdersModal()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
            
            <h2 class="text-2xl font-bold font-display mb-4 text-brand-dark">My Order History</h2>
            
            <div class="flex gap-2 mb-6">
                <input type="tel" id="history-phone" placeholder="Enter Mobile Number" class="flex-1 px-3 py-2 border rounded font-bold text-gray-700">
                <button onclick="fetchMyOrders()" class="bg-brand-red text-white px-4 py-2 rounded font-bold hover:bg-red-700">Check</button>
            </div>

            <div id="orders-list" class="space-y-3 max-h-[300px] overflow-y-auto">
                <p class="text-gray-400 text-center text-sm">Enter your number to see past orders.</p>
            </div>
        </div>
    </div>

    <script>
        // 1. CONFIGURATION
        const SUPABASE_URL = 'https://kjbelegkbusvtvtcgwhq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtqYmVsZWdrYnVzdnR2dGNnd2hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MjI5ODIsImV4cCI6MjA3NDA5ODk4Mn0.-K-rkuJnyDPL5YnkJ62-UG1_mG0BIILMUEZpSTNnq5M';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // State
        let menuItems = [];
        let cart = [];
        let categories = [];
        let activeCategory = 'All';

        // 2. INIT
        document.addEventListener('DOMContentLoaded', () => {
            fetchMenu();
            // Check local storage for previous user details
            const savedPhone = localStorage.getItem('dcb_user_phone');
            const savedName = localStorage.getItem('dcb_user_name');
            if(savedPhone) document.getElementById('checkout-phone').value = savedPhone;
            if(savedName) document.getElementById('checkout-name').value = savedName;
        });

        // 3. MENU FUNCTIONS
        async function fetchMenu() {
            const { data, error } = await supabase.from('menu_items').select('*').eq('in_stock', true);
            if (data) {
                menuItems = data;
                categories = ['All', ...new Set(data.map(i => i.category))];
                renderCategories();
                renderMenu();
            } else {
                // Fallback for demo
                document.getElementById('menu-grid').innerHTML = '<p class="text-center w-full p-10">Menu Loading Failed or Empty.</p>';
            }
        }

        function renderCategories() {
            document.getElementById('category-filters').innerHTML = categories.map(cat => `
                <button onclick="setCategory('${cat}')" 
                    class="px-5 py-2 rounded-full text-sm font-bold uppercase whitespace-nowrap transition
                    ${activeCategory === cat ? 'bg-brand-red text-white shadow-lg' : 'bg-white text-gray-600 border border-gray-200'}">
                    ${cat}
                </button>
            `).join('');
        }

        function setCategory(cat) {
            activeCategory = cat;
            renderCategories();
            renderMenu();
        }

        function renderMenu() {
            const container = document.getElementById('menu-grid');
            const filtered = activeCategory === 'All' ? menuItems : menuItems.filter(i => i.category === activeCategory);

            container.innerHTML = filtered.map((item, idx) => {
                const firstVariant = Object.keys(item.prices)[0];
                const price = item.prices[firstVariant];
                
                return `
                <div class="bg-white rounded-xl shadow-sm hover:shadow-lg transition border border-gray-100 overflow-hidden flex flex-col h-full">
                    <div class="p-5 flex-1 flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="text-lg font-bold font-display text-brand-dark">${item.name}</h3>
                                <span class="text-xs font-bold px-2 py-1 bg-gray-100 text-gray-500 rounded">${item.category}</span>
                            </div>
                            <p class="text-gray-500 text-sm mb-3 line-clamp-2">${item.description || 'Authentic flavor.'}</p>
                        </div>
                        <div class="flex items-center justify-between mt-2 pt-3 border-t border-dashed border-gray-200">
                            <span class="font-bold text-lg text-brand-red">₹${price}</span>
                            <button onclick="addToCart('${item.id}', '${item.name}', '${firstVariant}', ${price})" 
                                class="bg-brand-dark text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-800 transition">
                                ADD +
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // 4. CART FUNCTIONS
        function addToCart(id, name, variant, price) {
            const existing = cart.find(i => i.id === id && i.variant === variant);
            if (existing) {
                existing.qty++;
            } else {
                cart.push({ id, name, variant, price, qty: 1 });
            }
            renderCart();
            
            // Mobile Sidebar Auto-open logic (optional)
            if(window.innerWidth >= 768) {
                // On desktop, ensure sidebar is visible
                const sidebar = document.getElementById('cart-sidebar');
                sidebar.classList.remove('hidden'); 
            }
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            if (cart.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-48 text-gray-400"><p>Your cart is empty</p></div>`;
                updateTotals(0);
                return;
            }

            container.innerHTML = cart.map((item, idx) => `
                <div class="flex items-start justify-between bg-white p-2 rounded border border-gray-200 mb-2">
                    <div>
                        <div class="font-bold text-gray-800 text-sm">${item.name}</div>
                        <div class="text-xs text-gray-500">${item.variant}</div>
                        <div class="text-xs font-bold text-brand-red mt-1">₹${item.price * item.qty}</div>
                    </div>
                    <div class="flex items-center bg-gray-100 rounded border border-gray-300">
                        <button onclick="updateQty(${idx}, -1)" class="px-2 text-gray-600 font-bold hover:bg-gray-200">-</button>
                        <span class="text-xs font-bold w-6 text-center">${item.qty}</span>
                        <button onclick="updateQty(${idx}, 1)" class="px-2 text-gray-600 font-bold hover:bg-gray-200">+</button>
                    </div>
                </div>
            `).join('');

            const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            updateTotals(total);
        }

        function updateQty(idx, change) {
            cart[idx].qty += change;
            if (cart[idx].qty <= 0) cart.splice(idx, 1);
            renderCart();
        }

        function updateTotals(total) {
            document.getElementById('cart-subtotal').innerText = '₹' + total;
            document.getElementById('cart-total').innerText = '₹' + total;
            document.getElementById('mobile-cart-total').innerText = '₹' + total;
            
            const badgeCount = cart.reduce((acc, i) => acc + i.qty, 0);
            document.getElementById('cart-badge').innerText = badgeCount;
            document.getElementById('mobile-cart-badge').innerText = badgeCount;
            document.getElementById('cart-badge').classList.remove('scale-0');
            document.getElementById('mobile-cart-badge').classList.remove('scale-0');
            
            document.getElementById('checkout-btn').disabled = (total === 0);
        }

        // 5. CHECKOUT (NO LOGIN REQUIRED)
        async function placeOrder() {
            const phone = document.getElementById('checkout-phone').value.trim();
            const name = document.getElementById('checkout-name').value.trim();
            const btn = document.getElementById('checkout-btn');

            if (cart.length === 0) return alert("Cart is empty");
            if (phone.length < 10) return alert("Please enter a valid 10-digit mobile number");
            if (!name) return alert("Please enter your name");

            // Save for next time
            localStorage.setItem('dcb_user_phone', phone);
            localStorage.setItem('dcb_user_name', name);

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

            try {
                // A. Find or Create Customer
                let customerId;
                let { data: existing } = await supabase.from('customers').select('id').eq('phone', phone).single();

                if (existing) {
                    customerId = existing.id;
                } else {
                    const { data: newUser, error: createError } = await supabase
                        .from('customers')
                        .insert([{ name: name, phone: phone }])
                        .select()
                        .single();
                    if (createError) throw createError;
                    customerId = newUser.id;
                }

                // B. Insert Order
                const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
                const { error: orderError } = await supabase
                    .from('orders')
                    .insert([{
                        customer_id: customer