<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCB - Delhi Chicken Burger | Online Ordering</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            red: '#D92323', // Matched from logo roughly
                            dark: '#1a1a1a',
                            cream: '#f4f1ea',
                            gold: '#f59e0b'
                        }
                    },
                    fontFamily: {
                        display: ['Oswald', 'sans-serif'],
                        body: ['Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #D92323; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #b91c1c; 
        }
        .animate-bounce-short {
            animation: bounce-short 0.3s ease-in-out 2 alternate;
        }
        @keyframes bounce-short {
            0% { transform: translateY(0); }
            100% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="bg-brand-cream text-gray-800 font-body antialiased">

    <!-- Initialize Data Modal (Hidden by default) -->
    <div id="seedModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full shadow-2xl text-center">
            <i class="fa-solid fa-database text-4xl text-brand-red mb-4"></i>
            <h2 class="text-2xl font-bold font-display mb-2">Setup Database?</h2>
            <p class="text-gray-600 mb-6">Your menu appears to be empty. Would you like to upload the standard menu items (Kebabs, Curries, Rolls) to your database now?</p>
            <div class="flex gap-4 justify-center">
                <button onclick="closeSeedModal()" class="px-4 py-2 border border-gray-300 rounded text-gray-600 hover:bg-gray-50">No, Empty is fine</button>
                <button onclick="seedDatabase()" class="px-4 py-2 bg-brand-red text-white rounded hover:bg-red-700 font-bold shadow-lg">Yes, Upload Menu</button>
            </div>
            <p id="seedStatus" class="mt-4 text-sm font-semibold"></p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="sticky top-0 z-40 bg-white shadow-md border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo Area -->
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-brand-red rounded-full flex items-center justify-center text-white font-bold font-display text-xl border-2 border-brand-dark">
                        DCB
                    </div>
                    <div class="hidden md:block">
                        <h1 class="text-xl font-bold font-display tracking-wide text-brand-dark leading-none">DELHI CHICKEN BURGER</h1>
                        <span class="text-xs text-brand-red font-medium tracking-widest uppercase">Authentic Taste Legacy</span>
                    </div>
                </div>

                <!-- Desktop Nav -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="#" class="text-brand-dark hover:text-brand-red font-medium transition">Menu</a>
                    <a href="#" class="text-brand-dark hover:text-brand-red font-medium transition">About</a>
                    <a href="#" class="text-brand-dark hover:text-brand-red font-medium transition">Contact</a>
                </div>

                <!-- Cart Icon -->
                <div class="relative cursor-pointer" onclick="toggleCart()">
                    <div class="p-2 hover:bg-gray-100 rounded-full transition">
                        <i class="fa-solid fa-bag-shopping text-2xl text-brand-dark"></i>
                    </div>
                    <span id="cart-badge" class="absolute top-0 right-0 bg-brand-red text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full transform scale-0 transition-transform duration-200">0</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="relative bg-brand-dark text-white overflow-hidden">
        <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1555939594-58d7cb561ad1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80')] bg-cover bg-center opacity-40"></div>
        <div class="relative max-w-7xl mx-auto py-24 px-4 sm:px-6 lg:px-8 text-center sm:text-left">
            <h1 class="text-4xl md:text-6xl font-display font-bold mb-4 tracking-tight">
                THE REAL <span class="text-brand-red">TASTE OF DELHI</span>
            </h1>
            <p class="text-xl text-gray-300 mb-8 max-w-2xl">
                Experience the authentic flavors of roasted kebabs, creamy curries, and crunchy rolls. Directly from the grill to your doorstep.
            </p>
            <button onclick="scrollToMenu()" class="bg-brand-red hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:-translate-y-1">
                ORDER NOW
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 flex flex-col md:flex-row gap-8 relative">
        
        <!-- Menu Section -->
        <div class="flex-1">
            <!-- Categories Filters -->
            <div class="sticky top-20 z-30 bg-brand-cream py-4 -mx-4 px-4 md:mx-0 md:px-0 overflow-x-auto">
                <div class="flex space-x-2 md:flex-wrap" id="category-filters">
                    <!-- Filters injected by JS -->
                    <div class="animate-pulse flex space-x-2">
                        <div class="h-10 w-24 bg-gray-300 rounded-full"></div>
                        <div class="h-10 w-24 bg-gray-300 rounded-full"></div>
                        <div class="h-10 w-24 bg-gray-300 rounded-full"></div>
                    </div>
                </div>
            </div>

            <!-- Menu Grid -->
            <div id="menu-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 mt-6">
                <!-- Items injected by JS -->
                <div class="text-center col-span-full py-10 text-gray-500">
                    <i class="fa-solid fa-spinner fa-spin text-3xl mb-3"></i>
                    <p>Loading delicious menu...</p>
                </div>
            </div>
        </div>

        <!-- Cart Sidebar (Desktop Sticky / Mobile Drawer) -->
        <aside id="cart-sidebar" class="fixed inset-y-0 right-0 w-full sm:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 md:relative md:transform-none md:w-80 md:block md:translate-x-0 md:shadow-none md:bg-transparent hidden">
            <div class="h-full md:h-auto md:sticky md:top-24 bg-white md:rounded-xl md:shadow-lg overflow-hidden flex flex-col">
                
                <!-- Cart Header -->
                <div class="bg-brand-dark p-4 flex justify-between items-center text-white">
                    <h2 class="font-display text-xl font-bold"><i class="fa-solid fa-basket-shopping mr-2"></i> Your Order</h2>
                    <button class="md:hidden text-gray-300 hover:text-white" onclick="toggleCart()">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Cart Items Area -->
                <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-4 max-h-[60vh] min-h-[200px]">
                    <div class="flex flex-col items-center justify-center h-48 text-gray-400">
                        <i class="fa-solid fa-burger text-4xl mb-2 opacity-50"></i>
                        <p>Your cart is empty</p>
                        <p class="text-sm">Add some yummy food!</p>
                    </div>
                </div>

                <!-- Cart Footer / Checkout -->
                <div class="bg-gray-50 p-4 border-t border-gray-200">
                    <div class="flex justify-between mb-2 text-sm">
                        <span class="text-gray-600">Subtotal</span>
                        <span class="font-bold" id="cart-subtotal">₹0</span>
                    </div>
                    <div class="flex justify-between mb-4 text-xl font-display font-bold text-brand-dark">
                        <span>Total</span>
                        <span id="cart-total">₹0</span>
                    </div>

                    <!-- Checkout Form (Compact) -->
                    <div class="space-y-3 mb-4">
                        <input type="text" id="cust-name" placeholder="Your Name" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-brand-red text-sm">
                        <input type="tel" id="cust-phone" placeholder="Mobile Number" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-brand-red text-sm">
                        <textarea id="cust-note" placeholder="Address / Notes" rows="2" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-brand-red text-sm"></textarea>
                    </div>

                    <button onclick="placeOrder()" id="checkout-btn" class="w-full bg-brand-red text-white py-3 rounded-lg font-bold hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        PLACE ORDER
                    </button>
                </div>
            </div>
        </aside>

        <!-- Mobile Cart Toggle Button (Floating) -->
        <div class="fixed bottom-4 right-4 z-40 md:hidden">
            <button onclick="toggleCart()" class="bg-brand-dark text-white p-4 rounded-full shadow-xl flex items-center gap-2">
                <div class="relative">
                    <i class="fa-solid fa-bag-shopping text-xl"></i>
                    <span id="mobile-cart-badge" class="absolute -top-2 -right-2 bg-brand-red text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">0</span>
                </div>
                <span class="font-bold" id="mobile-cart-total">₹0</span>
            </button>
        </div>

    </main>

    <!-- Success Modal -->
    <div id="orderSuccessModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-8 max-w-sm w-full text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-check text-green-600 text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold font-display text-gray-800 mb-2">Order Placed!</h2>
            <p class="text-gray-600 mb-6">Your order #<span id="success-order-id" class="font-mono font-bold"></span> has been received.</p>
            <button onclick="location.reload()" class="w-full bg-brand-dark text-white py-2 rounded hover:bg-gray-800">Start New Order</button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-8 max-w-sm w-full shadow-2xl relative overflow-hidden">
            
            <div id="step-phone" class="space-y-4">
                <h2 class="text-2xl font-bold font-display text-brand-dark">Login to Order</h2>
                <p class="text-gray-500 text-sm">Enter your mobile number to continue. We will send you an OTP.</p>
                
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-400 uppercase">Mobile Number</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 rounded-l border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">+91</span>
                        <input type="tel" id="login-phone" placeholder="9999999999" class="flex-1 block w-full rounded-r border-gray-300 focus:border-brand-red focus:ring-brand-red sm:text-sm p-2 border">
                    </div>
                </div>

                <button onclick="sendOtp()" id="btn-send-otp" class="w-full bg-brand-dark text-white py-3 rounded font-bold hover:bg-gray-800 transition">
                    SEND OTP
                </button>
            </div>

            <div id="step-otp" class="space-y-4 hidden">
                <h2 class="text-2xl font-bold font-display text-brand-dark">Verify OTP</h2>
            categories: [],
            activeCategory: 'All',
            isLoading: true
        };

        // --- MENU DATA (For Seeding) ---
        // Transcribed from the uploaded image
        const SEED_DATA = [
            // Roasted
            { name: 'Juicy Chicken Kebab (Creamy)', category: 'ROASTED', description: 'Melt in mouth creamy kebab', prices: { 'Half (1 seekh)': 119, 'Full (2 seekh)': 199 } },
            { name: 'Minced Mutton Kebab (Creamy)', category: 'ROASTED', description: 'Rich mutton mince kebab', prices: { 'Half (1 seekh)': 159, 'Full (2 seekh)': 239 } },
            { name: 'Spicy Roasted Tangdi (Creamy)', category: 'ROASTED', description: 'Spicy roasted drumsticks', prices: { '2 pcs': 149, '4 pcs': 249 } },
            { name: 'Spicy Chicken Tikka (Dry)', category: 'ROASTED', description: 'Classic spicy tikka', prices: { '4 pcs': 199, '8 pcs': 299 } },
            { name: 'Chicken Malai Tikka (Creamy)', category: 'ROASTED', description: 'Mild creamy tikka', prices: { '4 pcs': 219, '8 pcs': 339 } },
            { name: 'Slurpy Afghani Chicken (Creamy)', category: 'ROASTED', description: 'Rich afghani sauce', prices: { '4 pcs': 259, '8 pcs': 359 } },
            { name: 'Chicken Salad Tikka (Creamy)', category: 'ROASTED', description: 'Healthy twist', prices: { '4 pcs': 239, '8 pcs': 299 } },
            { name: 'Tandoori Chicken (Dry)', category: 'ROASTED', description: 'Traditional clay oven roast', prices: { '4 pcs': 239, '8 pcs': 329 } },
            
            // Fried
            { name: 'Chicken Lollypop Spicy', category: 'FRIED', description: 'Spicy fried wings', prices: { '4 pcs': 239, '8 pcs': 349 } },
            { name: 'Spicy Fried Chicken', category: 'FRIED', description: 'Crispy spicy chicken', prices: { '4 pcs': 229, '8 pcs': 349 } },
            { name: 'Crispy Fried Tangdi', category: 'FRIED', description: 'Crunchy drumsticks', prices: { '2 pcs': 149, '4 pcs': 249 } },
            { name: 'Chicken Makkhni (Creamy)', category: 'FRIED', description: 'Buttery fried delight', prices: { '4 pcs': 259, '8 pcs': 399 } },
            { name: 'Crispy Fish Fry', category: 'FRIED', description: 'Golden fried fish', prices: { '2 pcs': 259, '4 pcs': 399 } },

            // Rolls
            { name: 'Chicken Tikka Roll', category: 'ROLLS', description: 'Wrapped in fresh bread', prices: { 'Standard': 139 } },
            { name: 'Chicken Kebab Roll', category: 'ROLLS', description: 'Juicy kebab wrap', prices: { 'Standard': 139 } },
            { name: 'Mutton Kebab Roll', category: 'ROLLS', description: 'Spicy mutton wrap', prices: { 'Standard': 179 } },
            
            // Breads
            { name: 'Roomali Roti', category: 'BREADS', description: 'Soft handkerchief bread', prices: { 'Per pc': 12 } },

            // Meal/Gravy
            { name: 'Chicken Korma', category: 'GRAVY', description: 'Rich spicy curry', prices: { 'Half (2 pcs)': 229, 'Full (5 pcs)': 399 } },
            { name: 'Butter Chicken', category: 'GRAVY', description: 'Classic creamy tomato gravy', prices: { 'Half (2 pcs)': 229, 'Full (5 pcs)': 399 } },
            { name: 'Spicy Chicken Curry', category: 'GRAVY', description: 'Homestyle curry', prices: { 'Half (2 pcs)': 199, 'Full (5 pcs)': 379 } },
            { name: 'Mughlai Chicken Biryani', category: 'GRAVY', description: 'Aromatic rice dish', prices: { 'Half (2 pcs)': 199, 'Full (5 pcs)': 379 } },
            { name: 'Egg Curry', category: 'GRAVY', description: 'Spicy egg gravy', prices: { '2 eggs': 119, '4 eggs': 199 } }
        ];

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchMenu();
        });

        // --- DB FUNCTIONS ---

        async function fetchMenu() {
            try {
                const { data, error } = await supabase.from('menu_items').select('*');
                
                if (error) throw error;

                if (!data || data.length === 0) {
                    // Database is empty, trigger seed modal
                    document.getElementById('seedModal').classList.remove('hidden');
                    // Use seed data locally for preview
                    processMenuData(SEED_DATA, true); 
                } else {
                    processMenuData(data, false);
                }
            } catch (err) {
                console.error('Error fetching menu:', err);
                // Fallback to local data if DB fails so site still looks good
                processMenuData(SEED_DATA, true);
                alert("Could not connect to live menu. Using offline mode.");
            }
        }

        async function seedDatabase() {
            const btn = document.querySelector('#seedModal button.bg-brand-red');
            const status = document.getElementById('seedStatus');
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Uploading...';
            btn.disabled = true;

            try {
                // Map local seed data to DB schema
                const records = SEED_DATA.map(item => ({
                    name: item.name,
                    category: item.category,
                    prices: item.prices,
                    description: item.description,
                    in_stock: true,
                    image_url: null // Or add placeholder URLs if desired
                }));

                const { data, error } = await supabase.from('menu_items').insert(records);
                
                if (error) throw error;

                status.innerText = "Success! Reloading...";
                status.className = "mt-4 text-green-600 font-bold";
                setTimeout(() => location.reload(), 1000);

            } catch (err) {
                console.error("Seeding failed", err);
                status.innerText = "Error: Check console. You might need to enable RLS policies or use a service key.";
                status.className = "mt-4 text-red-600 font-bold";
                btn.innerHTML = 'Try Again';
                btn.disabled = false;
            }
        }

        function closeSeedModal() {
            document.getElementById('seedModal').classList.add('hidden');
        }

        // --- DATA PROCESSING & RENDERING ---

        function processMenuData(data, isLocal) {
            state.menu = data;
            // Extract unique categories
            const cats = new Set(data.map(item => item.category));
            state.categories = ['All', ...Array.from(cats)];
            
            renderCategories();
            renderMenuGrid();
        }

        function renderCategories() {
            const container = document.getElementById('category-filters');
            container.innerHTML = state.categories.map(cat => `
                <button 
                    onclick="setCategory('${cat}')"
                    class="px-5 py-2 rounded-full text-sm font-bold uppercase tracking-wider transition whitespace-nowrap
                    ${state.activeCategory === cat 
                        ? 'bg-brand-red text-white shadow-md transform scale-105' 
                        : 'bg-white text-gray-600 hover:bg-gray-200 border border-gray-200'}"
                >
                    ${cat}
                </button>
            `).join('');
        }

        function setCategory(cat) {
            state.activeCategory = cat;
            renderCategories(); // Re-render to update active style
            renderMenuGrid();
        }

        function renderMenuGrid() {
            const container = document.getElementById('menu-grid');
            const filtered = state.activeCategory === 'All' 
                ? state.menu 
                : state.menu.filter(item => item.category === state.activeCategory);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-10 text-gray-400">No items found in this category.</div>`;
                return;
            }

            container.innerHTML = filtered.map((item, index) => {
                // Determine prices (handle JSONB format)
                const priceKeys = Object.keys(item.prices);
                const basePrice = item.prices[priceKeys[0]];
                
                // Create Select options for variants
                const variantOptions = priceKeys.map(key => 
                    `<option value="${key}"> ${key} - ₹${item.prices[key]}</option>`
                ).join('');

                return `
                <div class="bg-white rounded-xl shadow-sm hover:shadow-lg transition border border-gray-100 overflow-hidden flex flex-col group">
                    <div class="h-48 overflow-hidden bg-gray-100 relative">
                        <!-- Placeholder Image Logic -->
                        <div class="absolute inset-0 flex items-center justify-center text-gray-300 bg-gray-100">
                            <i class="fa-solid fa-drumstick-bite text-4xl"></i>
                        </div>
                        <img src="${item.image_url || `https://source.unsplash.com/400x300/?${item.category.toLowerCase()},food`}" 
                             onerror="this.style.display='none'"
                             alt="${item.name}" 
                             class="w-full h-full object-cover transform group-hover:scale-110 transition duration-500 relative z-10"
                        >
                        ${!item.in_stock ? '<div class="absolute inset-0 bg-white bg-opacity-80 z-20 flex items-center justify-center font-bold text-gray-500">OUT OF STOCK</div>' : ''}
                    </div>
                    
                    <div class="p-5 flex-1 flex flex-col">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-bold font-display text-brand-dark leading-tight">${item.name}</h3>
                            <span class="text-xs font-bold px-2 py-1 bg-gray-100 text-gray-500 rounded">${item.category}</span>
                        </div>
                        <p class="text-gray-500 text-sm mb-4 line-clamp-2">${item.description || 'Authentic delhi taste.'}</p>
                        
                        <div class="mt-auto pt-4 border-t border-dashed border-gray-200">
                            <div class="flex flex-col gap-2">
                                <select id="variant-${index}" class="text-sm border-gray-300 rounded focus:ring-brand-red focus:border-brand-red bg-gray-50 p-1">
                                    ${variantOptions}
                                </select>
                                <button 
                                    onclick="addToCart('${item.id || item.name}', ${index})"
                                    ${!item.in_stock ? 'disabled' : ''}
                                    class="w-full bg-brand-dark text-white py-2 rounded font-bold hover:bg-brand-red transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    ADD <i class="fa-solid fa-plus text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // --- CART LOGIC ---

        function addToCart(itemId, index) {
            // Find item by ID or Name (fallback for local data which might not have UUIDs yet)
            const item = state.menu.find(i => (i.id === itemId) || (i.name === itemId));
            const variantSelect = document.getElementById(`variant-${index}`);
            const variantName = variantSelect.value;
            const price = item.prices[variantName];

            // Check if item+variant already in cart
            const existing = state.cart.find(c => c.name === item.name && c.variant === variantName);

            if (existing) {
                existing.quantity++;
            } else {
                state.cart.push({
                    id: item.id, // Might be undefined if local seed, handled later
                    name: item.name,
                    variant: variantName,
                    price: price,
                    quantity: 1,
                    image: item.image_url
                });
            }

            renderCart();
            animateCartBadge();
        }

        function removeFromCart(cartIndex) {
            state.cart.splice(cartIndex, 1);
            renderCart();
        }

        function updateQuantity(cartIndex, change) {
            const item = state.cart[cartIndex];
            item.quantity += change;
            if (item.quantity <= 0) {
                removeFromCart(cartIndex);
            } else {
                renderCart();
            }
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            const subtotalEl = document.getElementById('cart-subtotal');
            const totalEl = document.getElementById('cart-total');
            const totalMobile = document.getElementById('mobile-cart-total');
            const badges = document.querySelectorAll('#cart-badge, #mobile-cart-badge');
            const checkoutBtn = document.getElementById('checkout-btn');

            if (state.cart.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-48 text-gray-400">
                        <i class="fa-solid fa-basket-shopping text-4xl mb-2 opacity-30"></i>
                        <p>Your cart is empty</p>
                    </div>`;
                subtotalEl.innerText = '₹0';
                totalEl.innerText = '₹0';
                totalMobile.innerText = '₹0';
                badges.forEach(b => { b.innerText = '0'; b.classList.add('scale-0'); });
                checkoutBtn.disabled = true;
                return;
            }

            // Calculate totals
            const total = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            // Update UI
            subtotalEl.innerText = '₹' + total;
            totalEl.innerText = '₹' + total;
            totalMobile.innerText = '₹' + total;
            
            const count = state.cart.reduce((acc, item) => acc + item.quantity, 0);
            badges.forEach(b => { 
                b.innerText = count; 
                b.classList.remove('scale-0'); 
            });

            checkoutBtn.disabled = false;

            // Render Items
            container.innerHTML = state.cart.map((item, idx) => `
                <div class="flex items-start gap-3 bg-white p-2 rounded shadow-sm border border-gray-100">
                    <div class="flex-1">
                        <h4 class="font-bold text-brand-dark text-sm leading-tight">${item.name}</h4>
                        <div class="text-xs text-gray-500 mb-1">${item.variant}</div>
                        <div class="flex items-center justify-between mt-2">
                            <span class="font-semibold text-brand-red">₹${item.price * item.quantity}</span>
                            
                            <div class="flex items-center bg-gray-100 rounded px-1">
                                <button onclick="updateQuantity(${idx}, -1)" class="px-2 py-1 text-gray-600 hover:text-red-600">-</button>
                                <span class="text-xs font-bold w-4 text-center">${item.quantity}</span>
                                <button onclick="updateQuantity(${idx}, 1)" class="px-2 py-1 text-gray-600 hover:text-green-600">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleCart() {
            const sidebar = document.getElementById('cart-sidebar');
            // Toggle classes to slide in/out or show/hide based on mobile/desktop
            if (window.innerWidth < 768) {
                // Mobile behavior (Drawer)
                if (sidebar.classList.contains('hidden')) {
                    sidebar.classList.remove('hidden');
                    setTimeout(() => sidebar.classList.remove('translate-x-full'), 10);
                } else {
                    sidebar.classList.add('translate-x-full');
                    setTimeout(() => sidebar.classList.add('hidden'), 300);
                }
            } else {
                // Desktop - Just scroll to it or highlight (it's always visible in layout)
                // If using hidden implementation on desktop:
                sidebar.classList.toggle('hidden');
            }
        }

        function animateCartBadge() {
            const badge = document.getElementById('cart-badge');
            badge.classList.add('animate-bounce-short');
            setTimeout(() => badge.classList.remove('animate-bounce-short'), 600);
        }

        function scrollToMenu() {
            document.getElementById('category-filters').scrollIntoView({ behavior: 'smooth' });
        }

        // --- ORDER SUBMISSION ---

        async function placeOrder() {
            const name = document.getElementById('cust-name').value.trim();
            const phone = document.getElementById('cust-phone').value.trim();
            const note = document.getElementById('cust-note').value.trim();
            const btn = document.getElementById('checkout-btn');

            if (!name || !phone) {
                alert("Please enter your name and phone number.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

            const totalAmount = state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            try {
                // 1. Create Order Record
                const { data: orderData, error: orderError } = await supabase
                    .from('orders')
                    .insert({
                        grand_total: totalAmount,
                        payment_mode: 'COD', // Defaulting to COD for simplicity
                        status: 'Pending',
                        order_type: 'Delivery', // Or 'Dine-in'
                        note: `Name: ${name}, Phone: ${phone}. ${note}`,
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();

                if (orderError) throw orderError;

                const orderId = orderData.id;

                // 2. Create Order Items
                const orderItems = state.cart.map(item => ({
                    order_id: orderId,
                    item_name: item.name,
                    variant: item.variant,
                    quantity: item.quantity,
                    price_per_unit: item.price
                }));

                const { error: itemsError } = await supabase
                    .from('order_items')
                    .insert(orderItems);

                if (itemsError) throw itemsError;

                // 3. Success
                document.getElementById('success-order-id').innerText = orderId;
                document.getElementById('orderSuccessModal').classList.remove('hidden');
                
                // Clear cart state
                state.cart = [];
                renderCart();

            } catch (err) {
                console.error("Order failed:", err);
                alert("Sorry, there was an issue placing your order. Please try again. \n" + err.message);
                btn.disabled = false;
                btn.innerText = 'PLACE ORDER';
            }
        }

    </script>
</body>
</html>