<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCB POS | Terminal 01</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- FontAwesome & Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Hotkeys (Mousetrap) for pro-level keyboard control -->
    <script src="https://cdn.jsdelivr.net/npm/mousetrap@1.6.5/mousetrap.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            red: '#D92323',
                            dark: '#1a1a1a',
                            cream: '#f4f1ea',
                            gray: '#f3f4f6',
                            green: '#16a34a'
                        }
                    },
                    fontFamily: {
                        display: ['Oswald', 'sans-serif'],
                        body: ['Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .pos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .ticket-pattern {
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 10px 10px;
        }
    </style>
</head>
<body class="bg-brand-dark h-screen overflow-hidden font-body flex flex-col md:flex-row text-gray-800">

    <!-- LEFT: MENU AREA (65%) -->
    <div class="flex-1 flex flex-col bg-gray-100 h-full relative">
        
        <!-- Top Bar: Search & Categories -->
        <div class="bg-white shadow-sm z-20">
            <div class="p-4 border-b border-gray-200 flex gap-4 items-center">
                <!-- Home / Admin Link -->
                <a href="admin.html" class="w-10 h-10 bg-brand-dark text-white rounded flex items-center justify-center hover:bg-gray-800 transition">
                    <i class="fa-solid fa-house"></i>
                </a>
                
                <!-- Search -->
                <div class="relative flex-1">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="pos-search" placeholder="Search Menu (Alt+S)..." class="w-full pl-10 pr-4 py-3 bg-gray-100 border-none rounded-lg focus:ring-2 focus:ring-brand-red text-lg font-bold">
                </div>
            </div>

            <!-- Categories -->
            <div class="flex overflow-x-auto p-2 gap-2 no-scrollbar border-b border-gray-200" id="category-bar">
                <!-- Injected via JS -->
                <div class="animate-pulse bg-gray-200 h-10 w-20 rounded"></div>
            </div>
        </div>

        <!-- Menu Grid -->
        <div class="flex-1 overflow-y-auto p-4 bg-brand-gray relative" id="menu-container">
            <div class="pos-grid" id="menu-grid">
                <!-- Cards Injected JS -->
            </div>
        </div>

        <!-- Bottom Status Bar -->
        <div class="bg-brand-dark text-gray-400 px-4 py-2 text-xs flex justify-between items-center">
            <span><i class="fa-solid fa-circle text-green-500 mr-2"></i>System Online</span>
            <span>Terminal: POS-01 &bull; Staff: Admin</span>
        </div>
    </div>

    <!-- RIGHT: BILLING CART (35%) -->
    <div class="w-full md:w-[450px] bg-white shadow-2xl z-30 flex flex-col h-full border-l border-gray-300">
        
        <!-- 1. Customer Info -->
        <div class="p-4 bg-brand-cream border-b border-orange-100">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-display font-bold text-lg text-brand-dark">CURRENT ORDER</h3>
                <span class="bg-white px-2 py-1 rounded text-xs font-bold border border-gray-200" id="order-id-display">NEW</span>
            </div>
            
            <div class="relative mb-2">
                <i class="fa-solid fa-phone absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                <input type="tel" id="cust-phone" onkeyup="lookupCustomer()" placeholder="Customer Phone (Required)" class="w-full pl-8 pr-3 py-2 border rounded focus:border-brand-red focus:outline-none text-sm font-bold tracking-wide">
                <!-- Success indicator -->
                <div id="cust-found-badge" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-green-600 hidden">
                    <i class="fa-solid fa-circle-check"></i>
                </div>
            </div>
            <input type="text" id="cust-name" placeholder="Customer Name" class="w-full px-3 py-2 border rounded focus:border-brand-red focus:outline-none text-sm bg-white">
        </div>

        <!-- 2. Order Type Toggle -->
        <div class="grid grid-cols-2 bg-gray-100 p-1 gap-1 border-b border-gray-200">
            <button onclick="setOrderType('Dine-in')" id="btn-dine" class="py-2 text-sm font-bold rounded bg-brand-dark text-white shadow">Dine-In</button>
            <button onclick="setOrderType('Takeaway')" id="btn-take" class="py-2 text-sm font-bold rounded text-gray-600 hover:bg-white">Takeaway</button>
        </div>

        <!-- 3. Cart Items (Scrollable) -->
        <div class="flex-1 overflow-y-auto p-2 ticket-pattern space-y-1" id="cart-list">
            <div class="h-full flex flex-col items-center justify-center text-gray-300 opacity-50">
                <i class="fa-solid fa-cash-register text-5xl mb-2"></i>
                <p>Ready for Order</p>
            </div>
        </div>

        <!-- 4. Payment & Totals -->
        <div class="bg-white border-t border-gray-200 p-4 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
            
            <!-- Summary Lines -->
            <div class="space-y-1 text-sm mb-4 text-gray-600">
                <div class="flex justify-between">
                    <span>Subtotal</span>
                    <span id="lbl-subtotal">₹0</span>
                </div>
                <div class="flex justify-between text-green-600">
                    <span>Discount</span>
                    <span>-₹0</span>
                </div>
                <div class="flex justify-between font-bold text-gray-800 text-lg border-t border-dashed border-gray-300 pt-2 mt-2">
                    <span>TOTAL TO PAY</span>
                    <span id="lbl-total">₹0</span>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button onclick="setPayMode('Cash')" id="pm-Cash" class="pay-btn active bg-gray-800 text-white border border-gray-800 py-2 rounded font-bold text-xs flex flex-col items-center gap-1">
                    <i class="fa-solid fa-money-bill-wave"></i> CASH
                </button>
                <button onclick="setPayMode('UPI')" id="pm-UPI" class="pay-btn bg-white text-gray-600 border border-gray-200 py-2 rounded font-bold text-xs flex flex-col items-center gap-1 hover:border-brand-red">
                    <i class="fa-solid fa-qrcode"></i> UPI
                </button>
                <button onclick="setPayMode('Card')" id="pm-Card" class="pay-btn bg-white text-gray-600 border border-gray-200 py-2 rounded font-bold text-xs flex flex-col items-center gap-1 hover:border-brand-red">
                    <i class="fa-solid fa-credit-card"></i> CARD
                </button>
            </div>

            <!-- Checkout Button -->
            <button onclick="processOrder()" id="btn-checkout" class="w-full bg-brand-green hover:bg-green-700 text-white py-4 rounded-lg font-bold text-xl shadow-lg flex items-center justify-center gap-3 transition transform active:scale-95">
                <span>CHECKOUT</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Variant Selector Modal -->
    <div id="variantModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden transform transition-all scale-100">
            <div class="bg-brand-red p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg" id="vm-title">Select Variant</h3>
                <button onclick="closeVariantModal()" class="text-white/80 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-4 space-y-2" id="vm-options">
                <!-- Options injected here -->
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://kjbelegkbusvtvtcgwhq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtqYmVsZWdrYnVzdnR2dGNnd2hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MjI5ODIsImV4cCI6MjA3NDA5ODk4Mn0.-K-rkuJnyDPL5YnkJ62-UG1_mG0BIILMUEZpSTNnq5M';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE ---
        let menuItems = [];
        let categories = [];
        let cart = [];
        let currentOrderType = 'Dine-in';
        let currentPayMode = 'Cash';
        let activeCustomer = null; // Found from DB

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchMenu();
            document.getElementById('pos-search').focus();
            
            // Hotkeys
            Mousetrap.bind(['command+s', 'ctrl+s'], (e) => { e.preventDefault(); document.getElementById('pos-search').focus(); });
            Mousetrap.bind(['enter'], () => { if(cart.length > 0) processOrder(); });
        });

        // --- DATA FETCHING ---
        async function fetchMenu() {
            const { data, error } = await supabase.from('menu_items').select('*').eq('in_stock', true);
            if(error) { console.error(error); return; }
            
            menuItems = data;
            categories = ['All', ...new Set(data.map(i => i.category))];
            
            renderCategories();
            renderMenu('All');
        }

        // --- RENDERING ---
        function renderCategories() {
            const bar = document.getElementById('category-bar');
            bar.innerHTML = categories.map(cat => `
                <button onclick="renderMenu('${cat}')" class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-bold hover:bg-brand-red hover:text-white hover:border-brand-red transition whitespace-nowrap shadow-sm">
                    ${cat}
                </button>
            `).join('');
        }

        function renderMenu(filterCat) {
            const grid = document.getElementById('menu-grid');
            const search = document.getElementById('pos-search').value.toLowerCase();
            
            const filtered = menuItems.filter(item => {
                const matchesCat = filterCat === 'All' || item.category === filterCat;
                const matchesSearch = item.name.toLowerCase().includes(search);
                return matchesCat && matchesSearch;
            });

            grid.innerHTML = filtered.map(item => `
                <div onclick="initiateAdd('${item.id}')" class="bg-white rounded-lg shadow p-3 cursor-pointer hover:shadow-lg hover:border-brand-red border border-transparent transition flex flex-col justify-between h-32 relative overflow-hidden group">
                    <div>
                        <div class="text-xs text-gray-400 font-bold uppercase mb-1 tracking-wider">${item.category}</div>
                        <h4 class="font-bold text-gray-800 leading-tight group-hover:text-brand-red">${item.name}</h4>
                    </div>
                    <div class="flex justify-between items-end mt-2">
                        <span class="font-mono text-xs bg-gray-100 px-1 rounded text-gray-600">
                             ${Object.keys(item.prices).length > 1 ? 'Multi-Price' : '₹' + Object.values(item.prices)[0]}
                        </span>
                        <div class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 group-hover:bg-brand-red group-hover:text-white transition">
                            <i class="fa-solid fa-plus text-xs"></i>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- SEARCH LISTENER ---
        document.getElementById('pos-search').addEventListener('keyup', () => renderMenu('All'));

        // --- ADD TO CART LOGIC ---
        function initiateAdd(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            const prices = item.prices;
            const keys = Object.keys(prices);

            if(keys.length === 1) {
                // Direct add
                addToCart(item, keys[0], prices[keys[0]]);
            } else {
                // Show modal
                showVariantModal(item);
            }
        }

        function showVariantModal(item) {
            const modal = document.getElementById('variantModal');
            const container = document.getElementById('vm-options');
            document.getElementById('vm-title').innerText = item.name;

            container.innerHTML = Object.entries(item.prices).map(([variant, price]) => `
                <button onclick="selectVariant('${item.id}', '${variant}', ${price})" class="w-full flex justify-between items-center p-4 border border-gray-200 rounded-lg hover:bg-red-50 hover:border-red-200 transition bg-gray-50">
                    <span class="font-bold text-gray-700">${variant}</span>
                    <span class="font-bold text-brand-red text-lg">₹${price}</span>
                </button>
            `).join('');

            modal.classList.remove('hidden');
        }

        function closeVariantModal() {
            document.getElementById('variantModal').classList.add('hidden');
        }

        function selectVariant(itemId, variant, price) {
            const item = menuItems.find(i => i.id === itemId);
            addToCart(item, variant, price);
            closeVariantModal();
        }

        function addToCart(item, variant, price) {
            const existing = cart.find(c => c.id === item.id && c.variant === variant);
            if(existing) {
                existing.qty++;
            } else {
                cart.push({
                    id: item.id,
                    name: item.name,
                    variant: variant,
                    price: price,
                    qty: 1
                });
            }
            renderCart();
        }

        // --- CART UI ---
        function renderCart() {
            const container = document.getElementById('cart-list');
            
            if(cart.length === 0) {
                container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-gray-300 opacity-50">
                        <i class="fa-solid fa-cash-register text-5xl mb-2"></i>
                        <p>No Items Added</p>
                    </div>`;
                updateTotals();
                return;
            }

            container.innerHTML = cart.map((item, idx) => `
                <div class="bg-white p-3 border-b border-dashed border-gray-300 flex justify-between items-start group">
                    <div class="flex-1">
                        <div class="font-bold text-gray-800 text-sm">${item.name}</div>
                        <div class="text-xs text-gray-500">${item.variant}</div>
                        <div class="text-xs font-bold text-gray-400 mt-1">₹${item.price} x ${item.qty}</div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <div class="font-bold text-gray-800">₹${item.price * item.qty}</div>
                        <div class="flex items-center bg-gray-100 rounded border border-gray-200">
                            <button onclick="updateQty(${idx}, -1)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-200 text-gray-600 font-bold">-</button>
                            <span class="w-6 text-center text-xs font-bold">${item.qty}</span>
                            <button onclick="updateQty(${idx}, 1)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-200 text-gray-600 font-bold">+</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            updateTotals();
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function updateQty(idx, change) {
            cart[idx].qty += change;
            if(cart[idx].qty <= 0) cart.splice(idx, 1);
            renderCart();
        }

        function updateTotals() {
            const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            document.getElementById('lbl-subtotal').innerText = '₹' + total;
            document.getElementById('lbl-total').innerText = '₹' + total;
        }

        // --- CUSTOMER & ORDER OPTIONS ---
        function setOrderType(type) {
            currentOrderType = type;
            document.getElementById('btn-dine').className = type === 'Dine-in' ? "py-2 text-sm font-bold rounded bg-brand-dark text-white shadow" : "py-2 text-sm font-bold rounded text-gray-600 hover:bg-white";
            document.getElementById('btn-take').className = type === 'Takeaway' ? "py-2 text-sm font-bold rounded bg-brand-dark text-white shadow" : "py-2 text-sm font-bold rounded text-gray-600 hover:bg-white";
        }

        function setPayMode(mode) {
            currentPayMode = mode;
            // Reset styles
            ['Cash', 'UPI', 'Card'].forEach(m => {
                const btn = document.getElementById(`pm-${m}`);
                if(m === mode) {
                    btn.className = "pay-btn active bg-gray-800 text-white border border-gray-800 py-2 rounded font-bold text-xs flex flex-col items-center gap-1";
                } else {
                    btn.className = "pay-btn bg-white text-gray-600 border border-gray-200 py-2 rounded font-bold text-xs flex flex-col items-center gap-1 hover:border-brand-red";
                }
            });
        }

        async function lookupCustomer() {
            const phone = document.getElementById('cust-phone').value;
            if(phone.length < 10) {
                activeCustomer = null;
                document.getElementById('cust-found-badge').classList.add('hidden');
                return;
            }

            // Debounce or just check on 10 digits
            if(phone.length === 10) {
                const { data, error } = await supabase.from('customers').select('*').eq('mobile_number', phone).single();
                if(data) {
                    activeCustomer = data;
                    document.getElementById('cust-name').value = data.first_name + (data.last_name ? ' ' + data.last_name : '');
                    document.getElementById('cust-found-badge').classList.remove('hidden');
                } else {
                    activeCustomer = null;
                    // Keep user typed name if they typed it, otherwise blank
                    document.getElementById('cust-found-badge').classList.add('hidden');
                }
            }
        }

        // --- CHECKOUT ---
        async function processOrder() {
            if(cart.length === 0) { alert("Cart is empty"); return; }
            
            const btn = document.getElementById('btn-checkout');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> PROCESSING...';
            btn.disabled = true;

            const phone = document.getElementById('cust-phone').value.trim();
            const name = document.getElementById('cust-name').value.trim();

            // 1. Validation
            if(!phone || phone.length < 10) {
                alert("A valid Customer Phone is required.");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            try {
                // 2. Call the Database Function we just created
                const { data: custResult, error: custError } = await supabase
                    .rpc('get_or_create_customer_pos', { 
                        p_phone: phone, 
                        p_name: name || 'Guest' 
                    });

                if(custError) throw custError;
                
                const customerId = custResult.id; 

                // 3. Create Order
                const grandTotal = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
                
                const { data: orderData, error: orderError } = await supabase
                    .from('orders')
                    .insert({
                        customer_id: customerId, // linking to the ID we got above
                        // REMOVED user_id field entirely since your table doesn't have it
                        grand_total: grandTotal,
                        payment_mode: currentPayMode,
                        status: 'Completed',
                        order_type: currentOrderType,
                        note: `Name: ${name}, Phone: ${phone}. (POS)`,
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();

                if(orderError) throw orderError;

                // 4. Create Order Items
                const orderItems = cart.map(i => ({
                    order_id: orderData.id,
                    item_name: i.name,
                    variant: i.variant,
                    quantity: i.qty,
                    price_per_unit: i.price
                }));

                const { error: itemsError } = await supabase.from('order_items').insert(orderItems);
                if(itemsError) throw itemsError;

                // 5. Success
                const statusMsg = custResult.status === 'created' ? 'New Profile Created' : 'Existing Profile Found';
                alert(`Order #${orderData.id} Successful!\n${statusMsg}`);
                
                // Reset POS
                cart = [];
                renderCart();
                document.getElementById('cust-phone').value = '';
                document.getElementById('cust-name').value = '';
                document.getElementById('cust-found-badge').classList.add('hidden');
                document.getElementById('pos-search').focus();

            } catch (err) {
                console.error("Checkout failed:", err);
                alert("Error placing order: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

    </script>
</body>
</html>
